<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NUCC Trip Attendance Sheet</title>
  <style>
    body {
      margin: 0;
      padding: 1.5rem;
      background: #f7f7f7;
      color: #222;
      font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    .top-section {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .top-section-left {
      flex: 2 1 0;
      min-width: 320px;
    }

    .top-section-right {
      flex: 1 1 420px;
      max-width: 520px;
      min-width: 320px;
      display: flex;
      align-items: stretch;
    }

    .top-section-right-inner {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      align-items: start;
      justify-content: center;
      gap: 1.25rem;
      height: 100%;
      width: 100%;
    }

    .miner-image {
      display: block;
      flex: 2 1 0;
      max-width: clamp(154px, 49%, 252px);
      max-height: 100%;
      height: auto;
      width: auto;
      object-fit: contain;
      align-self: center;
    }

    .banking-info {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.85rem;
      text-align: center;
      width: 100%;
      flex: 1 1 0;
      min-width: 0;
    }

    .banking-logo-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.4rem;
      width: 100%;
    }

    .banking-logo {
      max-width: 180px;
      width: 100%;
      height: auto;
      display: block;
      margin: 0 auto;
    }

    .banking-details {
      font-size: 0.95rem;
      line-height: 1.4;
      background: #ffffff;
      border: 1px solid #cfd8dc;
      border-radius: 0.5rem;
      padding: 0.75rem 1rem;
      box-shadow: 0 0.5rem 1.25rem rgba(0, 0, 0, 0.08);
      min-width: 200px;
      width: 100%;
      box-sizing: border-box;
    }

    .banking-actions {
      display: flex;
      justify-content: center;
      width: 100%;
    }

    .banking-edit-button {
      padding: 0.4rem 0.9rem;
      border-radius: 0.5rem;
      border: 1px solid #006064;
      background: #00838f;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s ease-in-out;
    }

    .banking-edit-button:hover,
    .banking-edit-button:focus {
      background: #0097a7;
    }

    .banking-details .banking-label {
      font-weight: 600;
      margin-right: 0.35rem;
      color: #004d40;
    }

    .banking-details p {
      margin: 0;
    }

    .banking-details p + p {
      margin-top: 0.35rem;
    }

    .header-row {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .header-logo-block {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 0.35rem;
    }

    .header-row img {
      height: 72px;
      width: auto;
      display: block;
    }

    .miner-image-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
      width: 100%;
    }

    .image-upload-button {
      padding: 0.3rem 0.75rem;
      font-size: 0.9rem;
      border-radius: 0.4rem;
      border: 1px solid #006064;
      background: #00796b;
      color: #fff;
      cursor: pointer;
      font-weight: 600;
    }

    .image-upload-button:hover,
    .image-upload-button:focus {
      background: #00897b;
    }

    h1 {
      margin: 0;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 1.4rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1.5rem;
      background: #fff;
    }

    th,
    td {
      border: 1px solid #ccc;
      padding: 0.4rem 0.5rem;
      text-align: left;
      vertical-align: top;
    }

    thead th {
      background: #eaeaea;
      font-weight: 600;
      text-align: center;
    }

    .reimburse-header {
      color: #1b5e20;
    }

    .reimburse-header .reimburse-label {
      color: #1b5e20;
    }

    .reimburse-header .due-label {
      color: #b00020;
      margin-left: 0.25rem;
    }

    caption {
      text-align: left;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }

    .meta-table th,
    .meta-table td {
      border-color: #999;
    }

    .meta-table thead th {
      background: #f0f0f0;
    }

    .expense-toggle-group {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin: 1rem 0;
    }

    .expense-toggle-group label {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      font-weight: 500;
    }

    .base-expense-inputs {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .base-expense-inputs label {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 500;
    }

    .base-expense-inputs input[type="number"] {
      width: 6rem;
      padding: 0.35rem 0.45rem;
      border-radius: 0.35rem;
      border: 1px solid #999;
      font-weight: 500;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      justify-content: flex-start;
      margin-top: 1rem;
    }

    .control-button {
      padding: 0.5rem 0.9rem;
      font-size: 0.95rem;
      border-radius: 0.4rem;
      border: 1px solid #0077b6;
      background: #0096c7;
      color: #fff;
      cursor: pointer;
    }

    .attendance-table {
      display: none;
    }

    .control-button.hide-on-mobile {
      display: inline-flex;
    }

    .control-button:hover {
      background: #00a8e8;
    }

    .warning-message {
      color: #b00020;
      font-weight: 600;
      margin: 0.5rem 0 0;
    }

    .mobile-tabs {
      display: block;
    }

    .mobile-tab-list {
      display: none;
    }

    .mobile-tab-panel {
      display: block;
    }

    .mobile-person-panel {
      display: block;
    }

    .mobile-person-panel .person-panel-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 0.75rem;
      margin-top: 0.5rem;
    }

    .mobile-person-panel label {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      font-weight: 600;
      background: #fff;
      border: 1px solid #cfd8dc;
      border-radius: 0.5rem;
      padding: 0.65rem 0.75rem;
    }

    .mobile-person-panel input,
    .mobile-person-panel textarea {
      font: inherit;
      padding: 0.4rem 0.45rem;
      border-radius: 0.4rem;
      border: 1px solid #bdbdbd;
      background: #fff;
    }

    .mobile-person-panel textarea {
      min-height: 4rem;
      resize: vertical;
    }

    .mobile-person-panel .mobile-checkbox-field {
      flex-direction: row;
      align-items: center;
      gap: 0.5rem;
    }

    .mobile-summary-line {
      margin-top: 0.25rem;
      font-weight: 600;
    }

    .mobile-add-person {
      display: none;
    }

    .name-input.duplicate-name {
      border-color: #b00020;
      background: #ffe8ec;
    }

    .read-only-amount {
      background: #f5f5f5;
      color: #555;
    }

    #notify-dialog {
      border: none;
      border-radius: 0.75rem;
      padding: 0;
      max-width: min(960px, 90vw);
      width: 100%;
      color: #222;
      box-shadow: 0 1.5rem 3rem rgba(0, 0, 0, 0.2);
    }

    #notify-dialog::backdrop {
      background: rgba(0, 0, 0, 0.35);
    }

    .notify-container {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      padding: 1.5rem;
      background: #fff;
      max-height: 80vh;
      box-sizing: border-box;
    }

    .notify-dialog-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }

    .notify-dialog-header h2 {
      margin: 0;
      font-size: 1.25rem;
    }

    .notify-close-button {
      border: none;
      background: transparent;
      font-size: 1.75rem;
      line-height: 1;
      cursor: pointer;
      color: #444;
    }

    .notify-close-button:hover,
    .notify-close-button:focus {
      color: #000;
    }

    .summary-preview {
      border: 1px solid #d0d0d0;
      border-radius: 0.5rem;
      padding: 1rem;
      background: #fff;
    }

    .summary-description {
      font-size: 0.95rem;
      margin: 1rem 0 0;
      line-height: 1.5;
    }

    .summary-description p {
      margin: 0 0 0.35rem;
    }

    .summary-description p:last-child {
      margin-bottom: 0;
    }

    .summary-description .summary-line-gold {
      color: #b8860b;
    }

    .summary-description .summary-line-green {
      color: #1b5e20;
    }

    .summary-description .summary-line-red {
      color: #b00020;
    }

    .summary-person {
      background: #fff;
      border: 1px solid #d0d0d0;
      border-radius: 0.5rem;
      padding: 0.75rem 1rem;
      margin-bottom: 1rem;
    }

    .summary-preview table {
      background: #fff;
    }

    .summary-preview input,
    .summary-preview textarea,
    .summary-preview select,
    .summary-preview button {
      pointer-events: none;
    }

    .summary-preview .summary-value,
    .summary-preview .summary-select,
    .summary-preview .summary-multiline {
      background: none;
      border: none;
      padding: 0;
      margin: 0;
      color: inherit;
      font: inherit;
    }

    .summary-preview .summary-value {
      display: block;
      width: 100%;
      flex: 1 1 auto;
    }

    .summary-preview .summary-value.summary-number {
      text-align: right;
    }

    .summary-preview .summary-multiline {
      display: block;
      white-space: pre-wrap;
    }

    .summary-preview .summary-select {
      display: inline-block;
      flex: 0 0 auto;
      min-width: 0;
    }

    .summary-preview .summary-select.name-select {
      min-width: 1.75rem;
      text-align: center;
    }

    .attendance-table input[type="text"],
    .attendance-table input[type="number"],
    .attendance-table textarea,
    .meta-table input[type="text"] {
      width: 100%;
      box-sizing: border-box;
      font: inherit;
      padding: 0.3rem;
      border: 1px solid #bdbdbd;
      border-radius: 0.3rem;
      background: #fff;
    }

    .consume-header {
      width: 2.5rem;
    }

    .consume-cell {
      text-align: center;
      width: 2.5rem;
    }

    .attendance-table input[type="number"] {
      text-align: right;
    }

    .attendance-table textarea {
      min-height: 2.2rem;
      resize: vertical;
    }

    .name-input-wrapper {
      display: flex;
      gap: 0.25rem;
      align-items: center;
    }

    .name-select {
      width: 1.75rem;
      min-width: 1.75rem;
      padding: 0.2rem;
      border: 1px solid #bdbdbd;
      border-radius: 0.3rem;
      background: #fff;
      font: inherit;
      height: 100%;
      cursor: pointer;
    }

    .name-input.bold {
      font-weight: 600;
    }

    .totals-row td {
      font-weight: 600;
      background: #f4f4f4;
    }

    .totals-row em {
      font-weight: 400;
      color: #666;
    }

    .fee-breakdown,
    .fee-value,
    .reimbursed-value {
      text-align: right;
      white-space: nowrap;
    }

    .amount-due {
      color: #b00020;
      font-weight: 600;
    }

    .amount-credit {
      color: #1b5e20;
      font-weight: 600;
    }

    .expense-total,
    .expense-consumers {
      font-size: 0.85rem;
      color: #333;
    }

    .tutorial-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1.5rem;
      z-index: 999;
    }

    .tutorial-overlay.is-hidden {
      display: none;
    }

    .tutorial-content {
      position: relative;
      max-width: 720px;
      width: min(100%, 720px);
      background: #ffffff;
      border-radius: 1rem;
      padding: 2rem 2.5rem;
      box-shadow: 0 1.5rem 3rem rgba(0, 0, 0, 0.25);
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
    }

    .tutorial-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      border: none;
      background: transparent;
      font-size: 2rem;
      line-height: 1;
      cursor: pointer;
      color: #4a4a4a;
    }

    .tutorial-close:hover,
    .tutorial-close:focus {
      color: #000;
    }

    .tutorial-video {
      width: 100%;
      border-radius: 0.75rem;
      background: #000;
      max-height: 60vh;
    }

    .banking-dialog {
      border: none;
      border-radius: 0.75rem;
      padding: 0;
      max-width: 480px;
      width: min(90vw, 480px);
      box-shadow: 0 1.5rem 3rem rgba(0, 0, 0, 0.2);
    }

    .banking-dialog::backdrop {
      background: rgba(0, 0, 0, 0.35);
    }

    .banking-dialog form {
      display: flex;
      flex-direction: column;
      gap: 0.85rem;
      padding: 1.25rem 1.5rem 1.5rem;
    }

    .banking-dialog h3 {
      margin: 0 0 0.25rem;
      font-size: 1.15rem;
    }

    .banking-dialog label {
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
      font-weight: 600;
    }

    .banking-dialog input[type="text"] {
      padding: 0.55rem 0.65rem;
      border: 1px solid #b0bec5;
      border-radius: 0.4rem;
      font: inherit;
    }

    .banking-dialog .banking-dialog-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
      margin-top: 0.25rem;
    }

    .banking-dialog button[type="submit"] {
      background: #00695c;
      color: #fff;
      border: 1px solid #00695c;
      padding: 0.55rem 1rem;
      border-radius: 0.45rem;
      cursor: pointer;
      font-weight: 600;
    }

    .banking-dialog button[type="submit"]:hover,
    .banking-dialog button[type="submit"]:focus {
      background: #00897b;
    }

    .banking-dialog .banking-dialog-cancel {
      background: transparent;
      color: #00695c;
      border: 1px solid #00695c;
      padding: 0.55rem 1rem;
      border-radius: 0.45rem;
      cursor: pointer;
      font-weight: 600;
    }

    .banking-dialog .banking-dialog-cancel:hover,
    .banking-dialog .banking-dialog-cancel:focus {
      background: #e0f2f1;
    }

    @media (max-width: 1100px) {
      body {
        padding: 1rem;
      }

      table {
        font-size: 0.9rem;
      }

      .top-section {
        align-items: center;
      }

      .top-section-left {
        flex-basis: 100%;
      }

      .header-row {
        flex-direction: column;
        align-items: flex-start;
      }

      .top-section-right {
        flex-basis: 100%;
        max-width: none;
        min-width: 0;
        justify-content: center;
      }

      .top-section-right-inner {
        grid-template-columns: 1fr;
        align-items: center;
        height: auto;
        text-align: center;
      }

      .miner-image {
        flex: 0 0 auto;
        max-width: 240px;
        height: auto;
      }

      .banking-info {
        align-items: center;
        max-width: 100%;
      }

      .banking-details {
        text-align: left;
      }

      .controls {
        justify-content: flex-start;
      }

      .control-button {
        width: 100%;
      }

      .control-button.hide-on-mobile {
        display: none;
      }

      .tutorial-content {
        padding: 1.5rem;
        max-height: 90vh;
      }

      .tutorial-video {
        max-height: 40vh;
      }

      .header-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }

      .header-row h1 {
        width: 100%;
        margin-top: 0.25rem;
      }

      .meta-table,
      .meta-table tbody,
      .meta-table tr,
      .meta-table th,
      .meta-table td {
        display: block;
        width: 100%;
      }

      .meta-table tr {
        margin-bottom: 0.75rem;
      }

      .meta-table th {
        margin-bottom: 0.35rem;
      }

      .expense-toggle-group {
        flex-direction: column;
        align-items: flex-start;
      }

      .base-expense-inputs {
        flex-direction: column;
      }

      .mobile-person-panel .person-panel-grid {
        grid-template-columns: 1fr;
      }

      .mobile-add-person {
        display: block;
        margin-top: 1rem;
      }

      .mobile-add-person .control-button {
        width: 100%;
      }

      #attendance-table {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div
    class="tutorial-overlay is-hidden"
    id="tutorial-overlay"
    role="dialog"
    aria-modal="true"
    aria-labelledby="tutorial-title"
  >
    <div class="tutorial-content">
      <button
        type="button"
        class="tutorial-close"
        id="tutorial-close"
        aria-label="Close tutorial"
      >
        &times;
      </button>
      <h2 id="tutorial-title">Welcome to the NUCC Trip Attendance Sheet</h2>
      <p>
        This dashboard helps you capture who attended the outing, record essential
        trip logistics, and track costs. As the trip leader, please ensure every
        participant is listed, expenses are allocated, and banking details are
        confirmed before submitting the sheet.
      </p>
      <video
        class="tutorial-video"
        id="tutorial-video"
        controls
        preload="metadata"
      >
        <source src="tutorial.mp4" type="video/mp4" />
        Your browser does not support the tutorial video.
      </video>
    </div>
  </div>

  <div class="mobile-tabs" id="mobile-tabs">
    <div
      class="mobile-tab-list"
      id="mobile-tab-list"
      role="tablist"
      aria-label="Trip sections"
    ></div>
    <div class="mobile-tab-panels" id="mobile-tab-panels">
      <div
        class="mobile-tab-panel is-active"
        id="general-panel"
        data-tab-id="general"
      >
    <div class="top-section">
      <div class="top-section-left">
        <div class="header-row">
          <div class="header-logo-block">
            <img id="banner-image" src="banner.png" alt="NUCC banner" />
            <button
              type="button"
              class="image-upload-button"
              id="replace-banner-button"
            >
              Replace banner
            </button>
            <input
              type="file"
              id="banner-image-input"
              accept="image/*"
              hidden
            />
          </div>
          <h1>Trip Attendance Sheet</h1>
        </div>

        <table class="meta-table">
          <tbody>
          <tr>
            <th scope="row">Date</th>
            <td>
              <input
                type="date"
                id="trip-date"
                placeholder="Starting date of the trip."
              />
            </td>
            <th scope="row">Location</th>
            <td>
              <input
                type="text"
                id="trip-location"
                placeholder="Use a short, clear name for where the trip took place — this will be used for tagging in transactions (e.g. Tuglow, Yagby)."
              />
            </td>
          </tr>
          <tr>
            <th scope="row">Trip Leader</th>
            <td>
              <input
                type="text"
                id="trip-leader"
                list="trip-leader-options"
                placeholder="That’s you! The main organizer or leader of the trip."
              />
            </td>
            <th scope="row">Clerk</th>
            <td>
              <input
                type="text"
                id="clerk"
                list="trip-leader-options"
                placeholder="The person responsible for handling payments and reimbursements (typically a committee member with access to the club bank account, e.g. the Treasurer)."
              />
            </td>
          </tr>
        </tbody>
      </table>

      <div class="expense-toggle-group" role="group" aria-label="Expense Columns">
        <label
          title="Check this if any members hired club horizontal gear (helmets, headtorches, etc.)."
        >
          <input type="checkbox" data-expense-key="horizontal-gear" checked />
          Horizontal Gear
        </label>
        <label
          title="Check this if the club's SRT kit was used on the trip."
        >
          <input type="checkbox" data-expense-key="srt-kit" checked />
          SRT Kit
        </label>
        <label
          title="Check this if any members provided transport and fuel was consumed for the trip."
        >
          <input type="checkbox" data-expense-key="petrol" checked />
          Petrol
        </label>
        <label
          title="A handy toggle to check or uncheck all fields in the Used SRT Kit? column at once."
        >
          <input type="checkbox" id="srt-kit-master-toggle" />
          SRT Kit (All)
        </label>
      </div>

      <div class="base-expense-inputs">
        <label for="horizontal-gear-rate">
          Horizontal Gear per person ($)
          <input type="number" id="horizontal-gear-rate" step="0.01" value="5" />
        </label>
        <label for="srt-kit-rate">
          SRT Kit per person ($)
          <input type="number" id="srt-kit-rate" step="0.01" value="5" />
        </label>
        <label for="maintenance-rate">
          Maintenance rate ($/km)
          <input
            type="number"
            id="maintenance-rate"
            step="0.001"
            value="0.025"
            min="0"
          />
        </label>
      </div>

      <div class="controls">
        <button
          class="control-button"
          type="button"
          id="add-row"
          title="Add a new row to the members table."
        >
          Add Row
        </button>
        <button
          class="control-button"
          type="button"
          id="remove-row"
          title="Remove the last row from the members table."
        >
          Remove Row
        </button>
        <button
          class="control-button"
          type="button"
          id="add-expense"
          title="Add a new expense category (pair of columns: Expense Name and Inc?). Use this for any additional shared costs not already included — e.g. Camping fees or Park entry tickets."
        >
          Add Expense
        </button>
        <button
          class="control-button"
          type="button"
          id="remove-expense"
          title="Remove the last added expense category from the table."
        >
          Remove Expense
        </button>
        <button
          class="control-button hide-on-mobile"
          type="button"
          id="save-json"
          title="Download this form as a JSON file for safekeeping or later reuse."
        >
          Save JSON
        </button>
        <button
          class="control-button hide-on-mobile"
          type="button"
          id="load-json"
          title="Load a previously saved Trip Attendance JSON file."
        >
          Load JSON
        </button>
        <button
          class="control-button"
          type="button"
          id="summarise-button"
          title="Generate a summary page showing the accounting breakdown for the trip — suitable for sharing with participants and storing in the NUCC Google Drive “Trip Sheets” folder."
        >
          Summarise
        </button>
      </div>
    </div>
    <div class="top-section-right">
      <div class="top-section-right-inner">
        <div class="banking-info">
          <div class="banking-logo-wrapper">
            <img
              src="banking_logo.png"
              alt="Banking logo"
              class="banking-logo"
              id="banking-logo"
            />
            <button
              type="button"
              class="image-upload-button"
              id="replace-banking-logo-button"
            >
              Replace banking logo
            </button>
            <input
              type="file"
              id="banking-logo-input"
              accept="image/*"
              hidden
            />
          </div>
          <div class="banking-details" id="banking-details" aria-live="polite">
            <p>
              <span class="banking-label">Name:</span>
              <span>Society Cheque Acct</span>
            </p>
            <p>
              <span class="banking-label">BSB:</span>
              <span>062903</span>
            </p>
            <p>
              <span class="banking-label">Account:</span>
              <span>10320366</span>
            </p>
          </div>
          <div class="banking-actions">
            <button
              type="button"
              class="banking-edit-button"
              id="edit-banking-details"
            >
              Edit banking details
            </button>
          </div>
        </div>
        <div class="miner-image-container">
          <img
            src="taxminer.png"
            alt="Tax Miner graphic"
            class="miner-image"
            id="miner-image"
          />
          <button
            type="button"
            class="image-upload-button"
            id="replace-miner-button"
          >
            Replace miner image
          </button>
          <input
            type="file"
            id="miner-image-input"
            accept="image/*"
            hidden
          />
        </div>
      </div>
    </div>
    <div class="mobile-add-person">
      <button type="button" class="control-button" id="add-person-mobile">
        Add Person
      </button>
    </div>
  </div>

  <p
    id="duplicate-name-warning"
    class="warning-message"
    role="alert"
    aria-live="polite"
    hidden
  ></p>

  <table class="attendance-table" id="attendance-table">
    <thead>
      <tr id="attendance-header">
        <th>Name</th>
      </tr>
    </thead>
    <tbody id="attendance-body"></tbody>
    <tfoot id="attendance-foot"></tfoot>
  </table>

  <input
    type="file"
    id="load-json-input"
    accept=".json,application/json"
    style="position: absolute; left: -10000px;"
    aria-hidden="true"
  />

      </div>
    </div>
  </div>

  <dialog class="banking-dialog" id="banking-dialog">
    <form id="banking-form" method="dialog">
      <h3>Edit banking details</h3>
      <p style="margin: 0; color: #444; font-size: 0.95rem; line-height: 1.4;">
        Update the account information shown on the right. Leave a field blank to keep the current value.
      </p>
      <label for="banking-name">
        Account name
        <input type="text" id="banking-name" name="banking-name" />
      </label>
      <label for="banking-bsb">
        BSB
        <input type="text" id="banking-bsb" name="banking-bsb" />
      </label>
      <label for="banking-account">
        Account number
        <input type="text" id="banking-account" name="banking-account" />
      </label>
      <div class="banking-dialog-actions">
        <button type="button" class="banking-dialog-cancel" id="banking-cancel">
          Cancel
        </button>
        <button type="submit">Save banking details</button>
      </div>
    </form>
  </dialog>

  <script>
    const tutorialOverlay = document.getElementById("tutorial-overlay");
    const tutorialCloseButton = document.getElementById("tutorial-close");
    const tutorialVideo = document.getElementById("tutorial-video");

    function hideTutorialOverlay() {
      if (!tutorialOverlay) return;
      tutorialOverlay.classList.add("is-hidden");
      if (tutorialVideo) {
        tutorialVideo.pause();
        tutorialVideo.currentTime = 0;
      }
    }

    if (tutorialOverlay) {
      window.addEventListener("load", () => {
        tutorialOverlay.classList.remove("is-hidden");
        if (tutorialCloseButton) {
          tutorialCloseButton.focus();
        }
      });

      tutorialOverlay.addEventListener("click", (event) => {
        if (event.target === tutorialOverlay) {
          hideTutorialOverlay();
        }
      });
    }

    if (tutorialCloseButton) {
      tutorialCloseButton.addEventListener("click", hideTutorialOverlay);
    }

    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape" && tutorialOverlay && !tutorialOverlay.classList.contains("is-hidden")) {
        hideTutorialOverlay();
      }
    });

    const nameListId = "member-options";
    const nameDatalist = document.createElement("datalist");
    nameDatalist.id = nameListId;
    document.body.appendChild(nameDatalist);

    const tripLeaderListId = "trip-leader-options";
    const tripLeaderDatalist = document.createElement("datalist");
    tripLeaderDatalist.id = tripLeaderListId;
    document.body.appendChild(tripLeaderDatalist);

    const tripLeaderInput = document.getElementById("trip-leader");
    const clerkInput = document.getElementById("clerk");
    const tripDateInput = document.getElementById("trip-date");
    const tripLocationInput = document.getElementById("trip-location");
    const editBankingButton = document.getElementById("edit-banking-details");
    const bankingDialog = document.getElementById("banking-dialog");
    const bankingForm = document.getElementById("banking-form");
    const bankingNameInput = document.getElementById("banking-name");
    const bankingBsbInput = document.getElementById("banking-bsb");
    const bankingAccountInput = document.getElementById("banking-account");
    const bankingCancelButton = document.getElementById("banking-cancel");
    const bannerImageElement = document.getElementById("banner-image");
    const minerImageElement = document.getElementById("miner-image");
    const bankingLogoElement = document.getElementById("banking-logo");
    const replaceBannerButton = document.getElementById("replace-banner-button");
    const replaceMinerButton = document.getElementById("replace-miner-button");
    const replaceBankingLogoButton = document.getElementById(
      "replace-banking-logo-button"
    );
    const bannerImageInput = document.getElementById("banner-image-input");
    const minerImageInput = document.getElementById("miner-image-input");
    const bankingLogoInput = document.getElementById("banking-logo-input");
    const mobileTabPanels = document.getElementById("mobile-tab-panels");
    const mobileAddPersonButton = document.getElementById("add-person-mobile");
    const generalPanel = document.getElementById("general-panel");

    if (tripLeaderInput) {
      tripLeaderInput.setAttribute("list", tripLeaderListId);
    }

    if (clerkInput) {
      clerkInput.setAttribute("list", tripLeaderListId);
    }

    if (tripDateInput) {
      tripDateInput.addEventListener("input", () => {
        renderBankingDetails();
      });
    }

    if (tripLocationInput) {
      tripLocationInput.addEventListener("input", () => {
        renderBankingDetails();
      });
    }

    let memberNames = [];
    const bakedBankingDefaults = {
      Name: "Society Cheque Acct",
      BSB: "062903",
      Account: "10320366"
    };
    let bankingDetailsData = null;
    let defaultBankingDetails = normalizeBankingDetails(bakedBankingDefaults);
    let bankingDetailsEdited = false;
    const defaultBannerSource =
      bannerImageElement?.getAttribute("src") || "banner.png";
    const defaultMinerSource =
      minerImageElement?.getAttribute("src") || "taxminer.png";
    const defaultBankingLogoSource =
      bankingLogoElement?.getAttribute("src") || "banking_logo.png";
    let bannerImageSource = defaultBannerSource;
    let minerImageSource = defaultMinerSource;
    let bankingLogoSource = defaultBankingLogoSource;

    const baseExpenseRates = {
      "horizontal-gear": 5,
      "srt-kit": 5
    };

    let maintenanceRate = 0.025;

    const legacyExpenseKeyMap = {
      "personal-gear": "horizontal-gear",
      "shared-gear": "srt-kit"
    };

    function normalizeExpenseKey(key) {
      if (typeof key !== "string") {
        return key;
      }
      return legacyExpenseKeyMap[key] || key;
    }

    function getPersonTabId(index) {
      return `person-${index}`;
    }

    function getPersonLabel(participant, index) {
      const name = (participant?.name || "").trim();
      return name || `Person ${index + 1}`;
    }

    function refreshMobileTabLabels() {
      document.querySelectorAll(".mobile-person-panel").forEach((panel) => {
        const personIndex = Number(panel.dataset.personIndex);
        if (!Number.isInteger(personIndex)) {
          return;
        }
        const participant = participants[personIndex];
        const heading = panel.querySelector("h2");
        if (heading) {
          heading.textContent = getPersonLabel(participant, personIndex);
        }
      });
    }

    function focusMobilePerson(personIndex) {
      const mobilePanel = document.querySelector(
        `.mobile-person-panel[data-person-index="${personIndex}"]`
      );
      const mobileNameInput = document.querySelector(
        `.mobile-name-input[data-person-index="${personIndex}"]`
      );
      if (mobilePanel) {
        mobilePanel.scrollIntoView({ behavior: "smooth", block: "start" });
      }
      if (mobileNameInput) {
        mobileNameInput.focus();
      }
    }

    function syncInputValueIfInactive(input, value, isCheckbox = false) {
      if (!input || document.activeElement === input) {
        return;
      }
      if (isCheckbox) {
        input.checked = Boolean(value);
      } else {
        input.value = value;
      }
    }

    const baseExpenseKeys = Object.keys(baseExpenseRates);

    const participants = Array.from({ length: 10 }, () => ({
      name: "",
      bold: false
    }));
    const baseExpenseDefinitions = [
      {
        key: "horizontal-gear",
        name: "Horizontal Gear",
        enabled: true,
        defaultConsumerState: false
      },
      {
        key: "srt-kit",
        name: "SRT Kit",
        enabled: true,
        defaultConsumerState: false
      },
      { key: "petrol", name: "Petrol", enabled: true, defaultConsumerState: true }
    ];

    const srtKitMasterToggle = document.getElementById("srt-kit-master-toggle");

    let customExpenseCounter = 0;

    function createExpense({
      name,
      key = null,
      type = "custom",
      enabled = true,
      defaultConsumerState = true
    }) {
      const id = type === "base" ? `base-${key}` : `custom-${customExpenseCounter++}`;
      return {
        id,
        name,
        key,
        type,
        enabled,
        defaultConsumerState,
        amounts: participants.map(() => ""),
        consumers: participants.map(() => defaultConsumerState)
      };
    }

    const baseExpenses = baseExpenseDefinitions.map((definition) =>
      createExpense({ ...definition, type: "base" })
    );

    const petrolExpense = baseExpenses.find((expense) => expense.key === "petrol");
    if (petrolExpense) {
      petrolExpense.distances = participants.map(() => "");
    }

    const customExpenses = [];

    if (tripDateInput && !tripDateInput.value) {
      const now = new Date();
      now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
      tripDateInput.value = now.toISOString().slice(0, 10);
    }

    const baseExpenseRateInputs = {
      "horizontal-gear": document.getElementById("horizontal-gear-rate"),
      "srt-kit": document.getElementById("srt-kit-rate")
    };

    const maintenanceRateInput = document.getElementById("maintenance-rate");

    function normalizeImageSource(source, fallback) {
      if (typeof source === "string" && source.trim()) {
        return source;
      }
      return fallback;
    }

    function syncImageElementSource(element, source, fallback) {
      if (!element) {
        return;
      }
      const resolved = normalizeImageSource(source, fallback);
      element.setAttribute("src", resolved);
    }

    function syncImageSources() {
      syncImageElementSource(bannerImageElement, bannerImageSource, defaultBannerSource);
      syncImageElementSource(minerImageElement, minerImageSource, defaultMinerSource);
      syncImageElementSource(
        bankingLogoElement,
        bankingLogoSource,
        defaultBankingLogoSource
      );
    }

    function setupImageReplacement(button, input, applySource) {
      if (button && input) {
        button.addEventListener("click", () => {
          input.value = "";
          input.click();
        });
      }

      if (!input) {
        return;
      }

      input.addEventListener("change", () => {
        const [file] = input.files;
        if (!file) {
          return;
        }

        const reader = new FileReader();
        reader.onload = () => {
          if (typeof reader.result === "string") {
            applySource(reader.result);
          }
        };
        reader.readAsDataURL(file);
      });
    }

    baseExpenseKeys.forEach((key) => {
      applyBaseExpenseRateToExpense(key);
    });

    function isBaseRateControlled(expense) {
      if (!expense || !expense.key) {
        return false;
      }
      return Object.prototype.hasOwnProperty.call(baseExpenseRates, expense.key);
    }

    function isDirectChargeExpense(expense) {
      if (!expense) {
        return false;
      }
      return expense.key === "horizontal-gear" || expense.key === "srt-kit";
    }

    function getExpenseHeaderLabel(expense) {
      if (!expense) {
        return "";
      }
      if (isDirectChargeExpense(expense)) {
        if (expense.key === "horizontal-gear") {
          return "Hired Horizontal Gear?";
        }
        if (expense.key === "srt-kit") {
          return "Used SRT Kit?";
        }
        return `${expense.name}?`;
      }
      return expense.name;
    }

    function applyBaseExpenseRateToExpense(key) {
      const expense = baseExpenses.find((item) => item.key === key);
      if (!expense) {
        return;
      }
      ensureExpenseSize(expense);
      const rate = baseExpenseRates[key];
      for (let index = 0; index < expense.amounts.length; index += 1) {
        expense.amounts[index] = rate === "" ? "" : rate;
      }
    }

    function syncBaseExpenseInputsFromRates() {
      baseExpenseKeys.forEach((key) => {
        const input = baseExpenseRateInputs[key];
        if (!input) {
          return;
        }
        const value = baseExpenseRates[key];
        input.value = value === "" ? "" : String(value);
      });
    }

    function syncMaintenanceRateInput() {
      if (!maintenanceRateInput) {
        return;
      }
      maintenanceRateInput.value = Number.isFinite(maintenanceRate)
        ? String(maintenanceRate)
        : "";
    }

    function updateDuplicateNameWarnings() {
      const warningElement = document.getElementById("duplicate-name-warning");
      const counts = new Map();

      participants.forEach((participant) => {
        const normalized = (participant.name || "").trim().toLowerCase();
        if (normalized) {
          counts.set(normalized, (counts.get(normalized) || 0) + 1);
        }
      });

      const duplicateKeys = new Set();
      counts.forEach((count, key) => {
        if (count > 1) {
          duplicateKeys.add(key);
        }
      });

      const nameInputs = Array.from(
        document.querySelectorAll(".name-input, .mobile-name-input")
      );
      nameInputs.forEach((input) => {
        const normalized = (input.value || "").trim().toLowerCase();
        if (normalized && duplicateKeys.has(normalized)) {
          input.classList.add("duplicate-name");
          input.setAttribute("aria-invalid", "true");
        } else {
          input.classList.remove("duplicate-name");
          input.removeAttribute("aria-invalid");
        }
      });

      if (warningElement) {
        if (duplicateKeys.size > 0) {
          const labels = [];
          participants.forEach((participant) => {
            const trimmed = (participant.name || "").trim();
            const normalized = trimmed.toLowerCase();
            if (trimmed && duplicateKeys.has(normalized) && !labels.includes(trimmed)) {
              labels.push(trimmed);
            }
          });
          warningElement.hidden = false;
          warningElement.textContent = `Duplicate names detected: ${labels.join(", ")}`;
        } else {
          warningElement.hidden = true;
          warningElement.textContent = "";
        }
      }
    }

    baseExpenseKeys.forEach((key) => {
      const input = baseExpenseRateInputs[key];
      if (!input) {
        return;
      }
      input.addEventListener("input", () => {
        const rawValue = input.value;
        if (rawValue === "") {
          baseExpenseRates[key] = "";
          applyBaseExpenseRateToExpense(key);
          renderTable();
          syncBaseExpenseInputsFromRates();
          return;
        }
        const numericValue = Number(rawValue);
        if (!Number.isFinite(numericValue)) {
          return;
        }
        baseExpenseRates[key] = numericValue;
        applyBaseExpenseRateToExpense(key);
        renderTable();
        syncBaseExpenseInputsFromRates();
      });
    });

    if (maintenanceRateInput) {
      syncMaintenanceRateInput();
      maintenanceRateInput.addEventListener("input", (event) => {
        const rawValue = event.target.value;
        if (rawValue === "") {
          maintenanceRate = 0;
          renderTable();
          syncMaintenanceRateInput();
          return;
        }
        const numericValue = Number(rawValue);
        if (!Number.isFinite(numericValue) || numericValue < 0) {
          return;
        }
        maintenanceRate = numericValue;
        renderTable();
        syncMaintenanceRateInput();
      });
    }

    function getAllExpenses() {
      return [...baseExpenses, ...customExpenses];
    }

    function getActiveExpenses() {
      return [
        ...baseExpenses.filter((expense) => expense.enabled),
        ...customExpenses
      ];
    }

    function getSrtKitExpense() {
      return baseExpenses.find((expense) => expense.key === "srt-kit");
    }

    function findExpenseById(id) {
      return getAllExpenses().find((expense) => expense.id === id);
    }

    function populateNameSelect(selectElement) {
      selectElement.innerHTML = "";

      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = "";
      placeholder.setAttribute("aria-hidden", "true");
      selectElement.appendChild(placeholder);

      memberNames.forEach((name) => {
        const option = document.createElement("option");
        option.value = name;
        option.textContent = name;
        selectElement.appendChild(option);
      });

      selectElement.value = "";
    }

    function cloneNodeWithFormValues(node) {
      const clone = node.cloneNode(true);
      const originals = node.querySelectorAll("input, textarea, select");
      const clones = clone.querySelectorAll("input, textarea, select");
      originals.forEach((element, index) => {
        const cloned = clones[index];
        if (!cloned) {
          return;
        }
        if (cloned.tagName === "INPUT") {
          const input = element;
          const cloneInput = cloned;
          if (input.type === "checkbox" || input.type === "radio") {
            cloneInput.checked = input.checked;
            if (input.checked) {
              cloneInput.setAttribute("checked", "");
            } else {
              cloneInput.removeAttribute("checked");
            }
          } else if (input.type === "file") {
            cloneInput.value = "";
            cloneInput.removeAttribute("value");
          } else {
            cloneInput.value = input.value;
            if (input.value === "") {
              cloneInput.removeAttribute("value");
            } else {
              cloneInput.setAttribute("value", input.value);
            }
          }
        } else if (cloned.tagName === "TEXTAREA") {
          cloned.value = element.value;
          cloned.textContent = element.value;
        } else if (cloned.tagName === "SELECT") {
          cloned.value = element.value;
          const selectedValues = Array.from(element.options)
            .filter((option) => option.selected)
            .map((option) => option.value);
          cloned.querySelectorAll("option").forEach((option) => {
            const isSelected = selectedValues.includes(option.value);
            option.selected = isSelected;
            if (isSelected) {
              option.setAttribute("selected", "");
            } else {
              option.removeAttribute("selected");
            }
          });
        }
      });
      return clone;
    }

    function stripIds(node) {
      if (node.nodeType === Node.ELEMENT_NODE) {
        node.removeAttribute("id");
        node
          .querySelectorAll("[id]")
          .forEach((element) => element.removeAttribute("id"));
      }
      return node;
    }

    function sanitizeSummaryClone(node) {
      node
        .querySelectorAll(
          ".expense-toggle-group, .base-expense-inputs, .controls, button, input[type=\"file\"]"
        )
        .forEach((element) => element.remove());

      node
        .querySelectorAll(".miner-image-container, .miner-image")
        .forEach((element) => element.remove());

      node.querySelectorAll('input[type="checkbox"]').forEach((checkbox) => {
        const replacement = node.ownerDocument.createElement("span");
        replacement.className = "summary-check";
        replacement.textContent = checkbox.checked ? "✔" : "";
        checkbox.replaceWith(replacement);
      });

      node.querySelectorAll("textarea").forEach((textarea) => {
        const display = node.ownerDocument.createElement("div");
        const classes = ["summary-multiline"];
        const existingClasses = textarea.className.trim();
        if (existingClasses) {
          classes.push(
            ...existingClasses
              .split(/\s+/)
              .filter((className) => className.length > 0)
          );
        }
        display.className = classes.join(" ");
        display.textContent = textarea.value || textarea.textContent || "";
        textarea.replaceWith(display);
      });

      node.querySelectorAll("select").forEach((select) => {
        const display = node.ownerDocument.createElement("span");
        const classes = ["summary-select"];
        const existingClasses = select.className.trim();
        if (existingClasses) {
          classes.push(
            ...existingClasses
              .split(/\s+/)
              .filter((className) => className.length > 0)
          );
        }
        display.className = classes.join(" ");

        const selectedOptions = Array.from(select.selectedOptions || []);
        const textContent = selectedOptions.length
          ? selectedOptions
              .map((option) => (option.textContent || "").trim())
              .filter((text) => text.length > 0)
              .join(", ")
          : select.value || "";
        display.textContent = textContent;
        select.replaceWith(display);
      });

      node.querySelectorAll("input").forEach((input) => {
        if (input.type === "checkbox") {
          return;
        }
        const display = node.ownerDocument.createElement("span");
        const classes = ["summary-value"];
        if (input.type === "number") {
          classes.push("summary-number");
        }
        const existingClasses = input.className.trim();
        if (existingClasses) {
          classes.push(
            ...existingClasses
              .split(/\s+/)
              .filter((className) => className.length > 0)
          );
        }
        display.className = classes.join(" ");
        let textContent = input.value || "";
        if (input.type === "number") {
          const { expenseId, distanceField } = input.dataset || {};
          if (distanceField === "true") {
            if (input.value !== "") {
              const numericValue = Number(input.value);
              textContent = Number.isFinite(numericValue)
                ? String(Math.round(numericValue))
                : "";
            } else {
              textContent = "";
            }
          } else if (expenseId) {
            const numericValue = Number(input.value);
            if (Number.isFinite(numericValue) && input.value !== "") {
              textContent = `$${formatCurrency(numericValue)}`;
            } else {
              textContent = "";
            }
          }
        }
        display.textContent = textContent;
        input.replaceWith(display);
      });

      return node;
    }

    function removeEmptySummaryNameRows(node) {
      node
        .querySelectorAll(".attendance-table tbody tr")
        .forEach((row) => {
          const nameElement =
            row.querySelector(".name-input") || row.querySelector("td");
          const textContent =
            (nameElement?.textContent || "").replace(/\s+/g, " ").trim();
          if (!textContent) {
            row.remove();
          }
        });
      return node;
    }

    function formatSummaryDate(rawValue) {
      if (!rawValue) {
        return "";
      }

      const parsed = new Date(rawValue);
      if (Number.isNaN(parsed.getTime())) {
        return rawValue;
      }

      try {
        return new Intl.DateTimeFormat(undefined, { dateStyle: "long" }).format(
          parsed
        );
      } catch (error) {
        return rawValue;
      }
    }

    function buildSummaryPreview(targetDocument) {
      const container = targetDocument.createElement("div");
      container.className = "summary-preview";

      const summaryDescription = targetDocument.createElement("div");
      summaryDescription.className = "summary-description";

      const maintenanceRateText = formatMaintenanceRateDisplay(
        getEffectiveMaintenanceRate()
      );

      const tripLocationValue = (tripLocationInput?.value || "").trim();
      const tripLeaderValue = (tripLeaderInput?.value || "").trim();
      const formattedDate = formatSummaryDate(tripDateInput?.value || "");
      const dateValue = formattedDate || tripDateInput?.value || "";

      const descriptionSegments = ["Cost accounting for"];
      if (tripLocationValue) {
        descriptionSegments.push(tripLocationValue);
      } else {
        descriptionSegments.push("this trip");
      }

      if (dateValue) {
        descriptionSegments.push(`on ${dateValue}`);
      }

      const descriptionParagraph = targetDocument.createElement("p");
      descriptionParagraph.textContent = `${descriptionSegments.join(" ")} for various expenses shown below.`;

      const leaderParagraph = targetDocument.createElement("p");
      leaderParagraph.className = "summary-line-gold";
      leaderParagraph.textContent = tripLeaderValue
        ? `Trip leader ${tripLeaderValue} should present this trip attendance summary to participants for review and confirmation of expenses. Once verified, a copy of the Trip Attendance Sheet should be sent to the treasurer to record dues and process reimbursements.`
        : "Trip leader should present this trip attendance summary to participants for review and confirmation of expenses. Once verified, a copy of the Trip Attendance Sheet should be sent to the treasurer to record dues and process reimbursements.";

      const reimburseParagraph = targetDocument.createElement("p");
      reimburseParagraph.className = "summary-line-green";
      reimburseParagraph.textContent =
        "Those with Reimburse values, colored green, will receive payment from the club account.";

      const oweParagraph = targetDocument.createElement("p");
      oweParagraph.className = "summary-line-red";
      oweParagraph.textContent =
        "If you owe, colored red in the Reimburse(Due), please pay to the club account details of which are provided in the top right.";

      summaryDescription.appendChild(descriptionParagraph);
      summaryDescription.appendChild(leaderParagraph);
      summaryDescription.appendChild(reimburseParagraph);
      summaryDescription.appendChild(oweParagraph);

      const srtKitParagraph = targetDocument.createElement("p");
      srtKitParagraph.textContent =
        "SRT kit refers to club-issued Single Rope Technique gear used on vertical trips. Ropes, rigging equipment, canyon packs, and other shared tools are maintained by the club and are not charged per use.";

      const horizontalGearParagraph = targetDocument.createElement("p");
      horizontalGearParagraph.textContent =
        "Horizontal gear covers helmets, headtorches, and similar equipment issued to individuals. A standard $5 charge applies when this option is selected.";

      const petrolParagraph = targetDocument.createElement("p");
      petrolParagraph.textContent =
        `Petrol expenses are reported by the drivers after the trip. Distances travelled are also recorded so that a maintenance charge of $${maintenanceRateText || "0"} per kilometre can be added. The combined total is pooled and divided equally among all participants, while each driver is credited $${maintenanceRateText || "0"} per kilometre to return maintenance funds to those who supplied vehicles.`;

      const versionParagraph = targetDocument.createElement("p");
      versionParagraph.className = "summary-version";
      versionParagraph.textContent = "Version: Nov 2025 – Current";

      summaryDescription.appendChild(srtKitParagraph);
      summaryDescription.appendChild(horizontalGearParagraph);
      summaryDescription.appendChild(petrolParagraph);
      summaryDescription.appendChild(versionParagraph);

      const summaryTextWrapper = targetDocument.createElement("div");
      summaryTextWrapper.className = "summary-description-text";
      while (summaryDescription.firstChild) {
        summaryTextWrapper.appendChild(summaryDescription.firstChild);
      }
      summaryDescription.appendChild(summaryTextWrapper);

      const sections = [];
      const topSection = document.querySelector(".top-section");
      if (topSection) {
        sections.push(topSection);
      }

      let descriptionInserted = false;

      sections.forEach((section) => {
        const clone = stripIds(cloneNodeWithFormValues(section));
        if (!clone) {
          return;
        }
        sanitizeSummaryClone(clone);
        removeEmptySummaryNameRows(clone);
        const imported = targetDocument.importNode(clone, true);

        const summaryBankingDetails = imported.querySelector(".banking-details");
        if (summaryBankingDetails) {
          renderBankingDetailsInto(summaryBankingDetails, targetDocument);
        }

        const summaryBankingLogo = imported.querySelector(".banking-logo");
        if (summaryBankingLogo && bankingLogoSource) {
          summaryBankingLogo.src = bankingLogoSource;
        }

        if (!descriptionInserted && section === topSection) {
          const metaTable = imported.querySelector(".meta-table");
          if (metaTable) {
            metaTable.insertAdjacentElement("afterend", summaryDescription);
          } else {
            imported.insertBefore(summaryDescription, imported.firstChild);
          }
          descriptionInserted = true;
        }
        container.appendChild(imported);
      });

      if (!descriptionInserted) {
        container.insertBefore(summaryDescription, container.firstChild);
      }

      const calculation = calculateFinancials(false);
      const peopleSection = targetDocument.createElement("section");
      peopleSection.className = "summary-people-section";
      const peopleHeading = targetDocument.createElement("h2");
      peopleHeading.textContent = "Participant balances";
      peopleSection.appendChild(peopleHeading);

      const participantEntries = participants
        .map((participant, index) => ({ participant, index }))
        .filter(({ participant }) => (participant.name || "").trim());

      participantEntries.forEach(({ participant, index }, displayIndex) => {
        const name = (participant.name || "").trim();
        const personWrapper = targetDocument.createElement("div");
        personWrapper.className = "summary-person";

        const balance = calculation.balances[index] || 0;
        const balanceLine = targetDocument.createElement("p");
        const amountText = `$${formatCurrency(Math.abs(balance)) || "0.00"}`;
        const balanceLabel = balance > 0 ? "Owes" : "Reimburse";
        const balanceClass = balance > 0 ? "amount-due" : "amount-credit";
        balanceLine.innerHTML = `<strong>${name}</strong>: ${balanceLabel} <span class="${balanceClass}">${amountText}</span>`;
        personWrapper.appendChild(balanceLine);

        const contributionDetails = calculation.participantContributionDetails[index] || [];
        const contributionItems = contributionDetails.filter(
          (entry) => entry && (Number(entry.value) || entry.distance)
        );
        if (contributionItems.length) {
          const contributionsHeading = targetDocument.createElement("p");
          contributionsHeading.textContent = "Contributions:";
          const list = targetDocument.createElement("ul");
          contributionItems.forEach((entry) => {
            const item = targetDocument.createElement("li");
            const pieces = [];
            if (Number(entry.value)) {
              pieces.push(`${entry.name}: $${formatCurrency(entry.value) || "0.00"}`);
            } else {
              pieces.push(entry.name);
            }
            if (entry.distance) {
              pieces.push(`${Math.round(entry.distance)} km`);
            }
            item.textContent = pieces.join(" – ");
            list.appendChild(item);
          });
          personWrapper.appendChild(contributionsHeading);
          personWrapper.appendChild(list);
        }

        const feeBreakdown = calculation.participantFeeBreakdowns[index] || [];
        if (feeBreakdown.length) {
          const breakdownHeading = targetDocument.createElement("p");
          breakdownHeading.textContent = "Fee breakdown:";
          const list = targetDocument.createElement("ul");
          feeBreakdown.forEach((entry) => {
            const item = targetDocument.createElement("li");
            item.textContent = `${entry.name}: $${formatCurrency(entry.value) || "0.00"}`;
            list.appendChild(item);
          });
          personWrapper.appendChild(breakdownHeading);
          personWrapper.appendChild(list);
        }

        peopleSection.appendChild(personWrapper);

        const isLastEntry = displayIndex === participantEntries.length - 1;
        const shouldBreak = (displayIndex + 1) % 3 === 0 && !isLastEntry;
        if (shouldBreak) {
          const pageBreak = targetDocument.createElement("div");
          pageBreak.className = "summary-page-break";
          peopleSection.appendChild(pageBreak);
        }
      });

      container.appendChild(peopleSection);

      const summaryTotals = targetDocument.createElement("section");
      const totalsHeading = targetDocument.createElement("h2");
      totalsHeading.textContent = "Summary";
      summaryTotals.appendChild(totalsHeading);

      const totalsList = targetDocument.createElement("ul");
      const totalFeesItem = targetDocument.createElement("li");
      totalFeesItem.textContent = `Total fees: $${formatCurrency(calculation.totalFees) || "0.00"}`;
      totalsList.appendChild(totalFeesItem);

      const balanceItem = targetDocument.createElement("li");
      const balanceLabel = calculation.totalBalance > 0 ? "Club Gear Depreciation (owed)" : "Club Gear Depreciation (credit)";
      balanceItem.textContent = `${balanceLabel}: ${
        calculation.totalBalance ? `$${formatCurrency(Math.abs(calculation.totalBalance))}` : "$0.00"
      }`;
      totalsList.appendChild(balanceItem);

      const incomeItem = targetDocument.createElement("li");
      incomeItem.textContent = `Club income: $${formatCurrency(calculation.clubIncome) || "0.00"}`;
      totalsList.appendChild(incomeItem);

      summaryTotals.appendChild(totalsList);
      container.appendChild(summaryTotals);

      return container;
    }

    function buildSummaryHtml(summaryTitle) {
      const summaryDocument = document.implementation.createHTMLDocument("");
      const resolvedTitle = summaryTitle || getDateLocationTag();
      summaryDocument.title = resolvedTitle;

      const metaCharset = summaryDocument.createElement("meta");
      metaCharset.setAttribute("charset", "utf-8");
      summaryDocument.head.appendChild(metaCharset);

      const baseHref = summaryDocument.createElement("base");
      baseHref.href = document.baseURI;
      summaryDocument.head.appendChild(baseHref);

      const existingStyle = document.querySelector("style");
      if (existingStyle) {
        summaryDocument.head.appendChild(
          summaryDocument.importNode(existingStyle, true)
        );
      }

      const extraStyle = summaryDocument.createElement("style");
      extraStyle.textContent = `
        .summary-check {
          display: inline-block;
          min-width: 1.5rem;
          text-align: center;
          font-weight: 600;
        }

        .summary-preview .top-section {
          align-items: flex-start;
          gap: 1.5rem;
        }

        .summary-preview .header-row {
          flex-wrap: nowrap;
          align-items: center;
          gap: 1.25rem;
        }

        .summary-preview .header-logo-block {
          align-items: flex-start;
        }

        .summary-preview .header-row h1 {
          margin-top: 0.35rem;
        }

        .summary-preview .top-section-left {
          width: 100%;
          max-width: none;
        }

        .summary-preview .top-section-right {
          flex: 0 0 auto;
          max-width: none;
          width: 100%;
        }

        .summary-preview .top-section-right-inner {
          display: flex;
          align-items: center;
          justify-content: flex-end;
          gap: 1.25rem;
          flex-wrap: wrap;
        }

        .summary-preview .banking-info {
          flex-direction: row;
          align-items: center;
          justify-content: flex-start;
          text-align: left;
          gap: 1rem;
          width: auto;
          max-width: none;
        }

        .summary-preview .banking-logo-wrapper {
          flex: 0 0 auto;
        }

        .summary-preview .banking-logo-wrapper .image-upload-button,
        .summary-preview .banking-logo-wrapper input[type="file"] {
          display: none;
        }

        .summary-preview .banking-details {
          width: auto;
          min-width: 240px;
          margin: 0;
        }

        .summary-preview .banking-actions {
          display: none;
        }

        .summary-preview .meta-table {
          width: auto;
        }

        .summary-preview .meta-table tbody {
          display: grid;
          grid-template-columns: repeat(2, minmax(0, 1fr));
          gap: 0.35rem 1rem;
          align-items: center;
        }

        .summary-preview .meta-table tr {
          display: contents;
        }

        .summary-preview .meta-table th {
          text-align: right;
          white-space: nowrap;
          padding: 0.2rem 0.4rem;
        }

        .summary-preview .meta-table td {
          padding: 0.2rem 0.4rem;
        }

        .summary-preview .summary-description {
          display: flex;
          align-items: flex-start;
          gap: 1.5rem;
        }

        .summary-preview .summary-description-text {
          flex: 1 1 0;
        }

        .summary-preview .summary-people-section {
          break-before: page;
          page-break-before: always;
        }

        .summary-preview .summary-page-break {
          break-before: page;
          page-break-before: always;
        }
      `;
      summaryDocument.head.appendChild(extraStyle);

      const main = summaryDocument.createElement("main");
      main.appendChild(buildSummaryPreview(summaryDocument));
      summaryDocument.body.appendChild(main);

      return `<!DOCTYPE html>${summaryDocument.documentElement.outerHTML}`;
    }

    function downloadAndOpenSummaryHtml() {
      const summaryTitle = getDateLocationTag();
      const htmlContent = buildSummaryHtml(summaryTitle);
      const blob = new Blob([htmlContent], { type: "text/html" });
      const url = URL.createObjectURL(blob);

      const downloadLink = document.createElement("a");
      downloadLink.href = url;
      downloadLink.download = `${summaryTitle}.html`;
      document.body.appendChild(downloadLink);
      downloadLink.click();
      document.body.removeChild(downloadLink);

      const summaryWindow = window.open("", "_blank");
      if (!summaryWindow) {
        window.alert("Please allow pop-ups to view the summary.");
        URL.revokeObjectURL(url);
        return;
      }

      summaryWindow.document.open();
      summaryWindow.document.write(htmlContent);
      summaryWindow.document.close();

      const ensureSummaryWindowTitle = () => {
        try {
          summaryWindow.document.title = summaryTitle;
        } catch (error) {
          /* no-op */
        }
      };

      ensureSummaryWindowTitle();

      if (typeof summaryWindow.addEventListener === "function") {
        summaryWindow.addEventListener("load", ensureSummaryWindowTitle, {
          once: true
        });
      }

      setTimeout(() => {
        URL.revokeObjectURL(url);
      }, 0);
    }

    async function loadMemberOptions() {
      try {
        const response = await fetch("members.csv");
        if (!response.ok) {
          return;
        }
        const text = await response.text();
        const rows = parseCsv(text);
        const names = new Set();

        rows.forEach((row, index) => {
          if (!row || row.length === 0) {
            return;
          }
          const rawName = (row[0] || "").trim().replace(/^"(.+)"$/, "$1");
          if (!rawName) {
            return;
          }
          if (index === 0 && /^(name|names)$/i.test(rawName)) {
            return;
          }
          names.add(rawName);
        });

        memberNames = Array.from(names).sort((a, b) => a.localeCompare(b));

        nameDatalist.innerHTML = "";
        tripLeaderDatalist.innerHTML = "";
        memberNames.forEach((name) => {
          const option = document.createElement("option");
          option.value = name;
          option.textContent = name;
          tripLeaderDatalist.appendChild(option);
          nameDatalist.appendChild(option.cloneNode(true));
        });

        document
          .querySelectorAll(".name-select")
          .forEach((select) => populateNameSelect(select));

        renderTable();
      } catch (error) {
        console.warn("Could not load member list", error);
      }
    }

    function formatCurrency(value) {
      if (!Number.isFinite(value)) return "";
      const fixed = Number(value).toFixed(2);
      return fixed === "-0.00" ? "0.00" : fixed;
    }

    function formatMaintenanceRateDisplay(value) {
      if (!Number.isFinite(value)) {
        return "";
      }
      const fixed = value.toFixed(3).replace(/0+$/, "").replace(/\.$/, "");
      return fixed || "0";
    }

    function getEffectiveMaintenanceRate() {
      return Number.isFinite(maintenanceRate) && maintenanceRate >= 0
        ? maintenanceRate
        : 0;
    }

    function parseCsv(text) {
      const rows = [];
      let currentRow = [];
      let currentValue = "";
      let inQuotes = false;

      for (let i = 0; i < text.length; i += 1) {
        const char = text[i];

        if (inQuotes) {
          if (char === '"') {
            if (text[i + 1] === '"') {
              currentValue += '"';
              i += 1;
            } else {
              inQuotes = false;
            }
          } else {
            currentValue += char;
          }
        } else if (char === '"') {
          inQuotes = true;
        } else if (char === ",") {
          currentRow.push(currentValue);
          currentValue = "";
        } else if (char === "\n") {
          currentRow.push(currentValue);
          rows.push(currentRow);
          currentRow = [];
          currentValue = "";
        } else if (char !== "\r") {
          currentValue += char;
        }
      }

      currentRow.push(currentValue);
      rows.push(currentRow);

      return rows.filter((row) => row.some((value) => value && value.trim() !== ""));
    }

    function syncExpenseToggleStates() {
      document
        .querySelectorAll('.expense-toggle-group input[type="checkbox"]')
        .forEach((checkbox) => {
          const key = checkbox.dataset.expenseKey;
          const expense = baseExpenses.find((item) => item.key === key);
          if (expense) {
            checkbox.checked = expense.enabled;
          }
        });
    }

    function getDateLocationTag() {
      const fallbackDate = new Date();
      const dateString = tripDateInput?.value && /^\d{4}-\d{2}-\d{2}$/.test(tripDateInput.value)
        ? tripDateInput.value
        : fallbackDate.toISOString().slice(0, 10);
      const formattedDate = dateString.replace(/-/g, "_");

      const rawLocation = tripLocationInput?.value ? tripLocationInput.value.trim() : "";
      const sanitizedLocation = rawLocation
        .replace(/[^A-Za-z0-9]+/g, "_")
        .replace(/^_+|_+$/g, "");
      const locationPart = sanitizedLocation || "Unknown";

      return `${formattedDate}_${locationPart}`;
    }

    function getFileBaseName(extension) {
      const tag = getDateLocationTag();
      return `${tag}.${extension}`;
    }

    function buildApplicationState() {
      const snapshot = {
        trip: {
          date: tripDateInput ? tripDateInput.value : "",
          location: tripLocationInput ? tripLocationInput.value : "",
          leader: tripLeaderInput ? tripLeaderInput.value : "",
          clerk: clerkInput ? clerkInput.value : ""
        },
        bankingDetails: getCurrentBankingDetails(),
        baseExpenseRates: { ...baseExpenseRates },
        maintenanceRate,
        baseExpenses: baseExpenses.map((expense) => {
          const snapshot = {
            key: expense.key,
            name: expense.name,
            enabled: expense.enabled,
            amounts: [...expense.amounts],
            consumers: [...expense.consumers]
          };
          if (expense.key === "petrol") {
            snapshot.distances = Array.isArray(expense.distances)
              ? expense.distances.map((value) => {
                  if (value === "" || value === null) {
                    return "";
                  }
                  const numeric = Number(value);
                  return Number.isFinite(numeric) ? Math.max(0, Math.round(numeric)) : "";
                })
              : [];
          }
          return snapshot;
        }),
        customExpenses: customExpenses.map((expense) => ({
          name: expense.name,
          enabled: expense.enabled,
          amounts: [...expense.amounts],
          consumers: [...expense.consumers]
        })),
        participants: participants.map((participant) => ({
          name: participant.name,
          bold: participant.bold
        })),
        images: {
          banner: bannerImageSource,
          miner: minerImageSource,
          banking: bankingLogoSource
        },
        srtKitAllSelected: Boolean(
          srtKitMasterToggle && srtKitMasterToggle.checked
        )
      };

      return snapshot;
    }

    function downloadAttendanceJson() {
      const state = buildApplicationState();
      const jsonContent = JSON.stringify(state, null, 2);
      const blob = new Blob([jsonContent], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = getFileBaseName("json");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    function applyExpenseSnapshot(expense, snapshotEntry) {
      const participantCount = participants.length;
      const amounts = Array.isArray(snapshotEntry?.amounts)
        ? snapshotEntry.amounts
        : [];
      const consumers = Array.isArray(snapshotEntry?.consumers)
        ? snapshotEntry.consumers
        : [];

      if (snapshotEntry && typeof snapshotEntry.enabled === "boolean") {
        expense.enabled = snapshotEntry.enabled;
      }

      if (isBaseRateControlled(expense)) {
        applyBaseExpenseRateToExpense(expense.key);
      } else {
        expense.amounts = Array.from({ length: participantCount }, (_, index) =>
          index < amounts.length ? amounts[index] : ""
        );
      }

      expense.consumers = Array.from({ length: participantCount }, (_, index) => {
        if (index < consumers.length) {
          return Boolean(consumers[index]);
        }
        return Object.prototype.hasOwnProperty.call(expense, "defaultConsumerState")
          ? expense.defaultConsumerState
          : true;
      });

      if (expense.key === "petrol") {
        const distances = Array.isArray(snapshotEntry?.distances)
          ? snapshotEntry.distances
          : [];
        expense.distances = Array.from({ length: participantCount }, (_, index) => {
          if (index < distances.length) {
            const value = distances[index];
            if (value === "" || value === null) {
              return "";
            }
            const numeric = Number(value);
            return Number.isFinite(numeric) ? Math.max(0, Math.round(numeric)) : "";
          }
          return "";
        });
      }
    }

    function applyApplicationState(state) {
      if (!state || typeof state !== "object") {
        window.alert("Invalid JSON data.");
        return;
      }

      const {
        trip,
        participants: participantData,
        baseExpenses: baseData,
        customExpenses: customData,
        baseExpenseRates: rateData,
        maintenanceRate: maintenanceRateData,
        bankingDetails,
        srtKitAllSelected,
        sharedGearAllSelected,
        images
      } = state;

      if (tripDateInput) {
        tripDateInput.value = trip?.date || "";
      }
      if (tripLocationInput) {
        tripLocationInput.value = trip?.location || "";
      }
      if (tripLeaderInput) {
        tripLeaderInput.value = trip?.leader || "";
      }
      if (clerkInput) {
        clerkInput.value = trip?.clerk || "";
      }

      if (Object.prototype.hasOwnProperty.call(state, "bankingDetails")) {
        bankingDetailsData = normalizeBankingDetails(bankingDetails || {});
        bankingDetailsEdited = true;
      }

      participants.length = 0;
      if (Array.isArray(participantData) && participantData.length > 0) {
        participantData.forEach((entry) => {
          participants.push({
            name: entry?.name || "",
            bold: Boolean(entry?.bold)
          });
        });
      } else {
        participants.push({ name: "", bold: false });
      }

      if (rateData && typeof rateData === "object") {
        Object.entries(rateData).forEach(([rawKey, rawValue]) => {
          const key = normalizeExpenseKey(rawKey);
          if (!Object.prototype.hasOwnProperty.call(baseExpenseRates, key)) {
            return;
          }
          if (rawValue === "" || rawValue === null) {
            baseExpenseRates[key] = "";
            return;
          }
          const numeric = Number(rawValue);
          baseExpenseRates[key] = Number.isFinite(numeric)
            ? numeric
            : baseExpenseRates[key];
        });
      }

      if (maintenanceRateData !== undefined) {
        const numeric = Number(maintenanceRateData);
        maintenanceRate = Number.isFinite(numeric) && numeric >= 0 ? numeric : maintenanceRate;
      }

      if (images && typeof images === "object") {
        bannerImageSource = normalizeImageSource(
          images.banner,
          defaultBannerSource
        );
        minerImageSource = normalizeImageSource(
          images.miner,
          defaultMinerSource
        );
        bankingLogoSource = normalizeImageSource(
          images.banking,
          defaultBankingLogoSource
        );
      } else {
        bannerImageSource = defaultBannerSource;
        minerImageSource = defaultMinerSource;
        bankingLogoSource = defaultBankingLogoSource;
      }

      syncImageSources();

      baseExpenses.forEach((expense) => {
        const snapshotEntry = Array.isArray(baseData)
          ? baseData.find(
              (item) => item && normalizeExpenseKey(item.key) === expense.key
            )
          : null;
        applyExpenseSnapshot(expense, snapshotEntry);
      });

      customExpenses.length = 0;
      customExpenseCounter = 0;
      if (Array.isArray(customData)) {
        customData.forEach((entry) => {
          const customExpense = createExpense({ name: entry?.name || "Custom Expense" });
          if (typeof entry?.enabled === "boolean") {
            customExpense.enabled = entry.enabled;
          }
          customExpense.amounts = Array.from({ length: participants.length }, (_, index) => {
            if (Array.isArray(entry?.amounts) && index < entry.amounts.length) {
              return entry.amounts[index];
            }
            return "";
          });
          customExpense.consumers = Array.from({ length: participants.length }, (_, index) => {
            if (Array.isArray(entry?.consumers) && index < entry.consumers.length) {
              return Boolean(entry.consumers[index]);
            }
            return customExpense.defaultConsumerState;
          });
          customExpenses.push(customExpense);
        });
      }

      syncBaseExpenseInputsFromRates();
      syncMaintenanceRateInput();
      syncExpenseToggleStates();
      renderTable();

      if (srtKitMasterToggle) {
        const desiredSelection =
          srtKitAllSelected !== undefined
            ? srtKitAllSelected
            : sharedGearAllSelected;
        srtKitMasterToggle.checked = Boolean(desiredSelection);
        syncSrtKitMasterToggleState();
      }

      renderBankingDetails();
    }

    function loadTableFromJsonContent(text) {
      try {
        const parsed = JSON.parse(text);
        applyApplicationState(parsed);
      } catch (error) {
        console.error("Could not parse JSON", error);
        window.alert("Could not load JSON. Please check the file format.");
      }
    }

    function ensureExpenseSize(expense) {
      const needed = participants.length;
      const rateKey = isBaseRateControlled(expense) ? expense.key : null;
      const rateValue = rateKey ? baseExpenseRates[rateKey] : null;
      while (expense.amounts.length < needed) {
        if (rateKey) {
          expense.amounts.push(rateValue === "" ? "" : rateValue);
        } else {
          expense.amounts.push("");
        }
      }
      while (expense.consumers.length < needed) {
        const defaultState = Object.prototype.hasOwnProperty.call(
          expense,
          "defaultConsumerState"
        )
          ? expense.defaultConsumerState
          : true;
        expense.consumers.push(defaultState);
      }
      while (expense.amounts.length > needed) {
        expense.amounts.pop();
      }
      while (expense.consumers.length > needed) {
        expense.consumers.pop();
      }
      if (expense.key === "petrol") {
        if (!Array.isArray(expense.distances)) {
          expense.distances = [];
        }
        while (expense.distances.length < needed) {
          expense.distances.push("");
        }
        while (expense.distances.length > needed) {
          expense.distances.pop();
        }
      }
    }

    function syncAllExpenseSizes() {
      getAllExpenses().forEach(ensureExpenseSize);
    }

    function createMobilePersonPanel(participant, personIndex, activeExpenses) {
      const panel = document.createElement("div");
      panel.className = "mobile-tab-panel mobile-person-panel";
      panel.dataset.tabId = getPersonTabId(personIndex);
      panel.dataset.personIndex = String(personIndex);

      const heading = document.createElement("h2");
      heading.textContent = getPersonLabel(participant, personIndex);
      panel.appendChild(heading);

      const grid = document.createElement("div");
      grid.className = "person-panel-grid";

      const nameLabel = document.createElement("label");
      nameLabel.textContent = "Name";
      const nameInput = document.createElement("input");
      nameInput.type = "text";
      nameInput.value = participant.name;
      nameInput.setAttribute("list", nameListId);
      nameInput.dataset.personIndex = String(personIndex);
      nameInput.className = "mobile-name-input";
      nameInput.addEventListener("input", (event) => {
        const value = event.target.value;
        participants[personIndex].name = value;
        const desktopInput = document.querySelector(
          `.name-input[data-person-index="${personIndex}"]`
        );
        if (desktopInput) {
          desktopInput.value = value;
        }
        refreshMobileTabLabels();
        recalculate();
        updateDuplicateNameWarnings();
      });
      nameLabel.appendChild(nameInput);
      grid.appendChild(nameLabel);

      activeExpenses.forEach((expense) => {
        ensureExpenseSize(expense);
        const label = document.createElement("label");
        label.textContent = getExpenseHeaderLabel(expense);

        if (isDirectChargeExpense(expense)) {
          label.classList.add("mobile-checkbox-field");
          const consumeInput = document.createElement("input");
          consumeInput.type = "checkbox";
          consumeInput.checked = Boolean(expense.consumers[personIndex]);
          consumeInput.dataset.expenseId = expense.id;
          consumeInput.dataset.personIndex = String(personIndex);
          consumeInput.className = "mobile-direct-charge";
          consumeInput.addEventListener("change", (event) => {
            const targetExpense = findExpenseById(event.target.dataset.expenseId);
            if (!targetExpense) {
              return;
            }
            const index = Number(event.target.dataset.personIndex);
            targetExpense.consumers[index] = event.target.checked;
            const desktopConsume = document.querySelector(
              `.attendance-table input[type="checkbox"][data-expense-id="${expense.id}"][data-person-index="${index}"]`
            );
            if (desktopConsume) {
              desktopConsume.checked = event.target.checked;
            }
            recalculate();
          });
          label.appendChild(consumeInput);
          grid.appendChild(label);
          return;
        }

        const amountInput = document.createElement("input");
        amountInput.type = "number";
        amountInput.step = "0.01";
        amountInput.placeholder = "0.00";
        amountInput.value =
          expense.amounts[personIndex] !== ""
            ? expense.amounts[personIndex]
            : "";
        amountInput.dataset.expenseId = expense.id;
        amountInput.dataset.personIndex = String(personIndex);
        amountInput.className = "mobile-amount-input";
        if (isBaseRateControlled(expense)) {
          const rate = baseExpenseRates[expense.key];
          amountInput.value = rate === "" ? "" : rate;
          amountInput.readOnly = true;
          amountInput.tabIndex = -1;
          amountInput.classList.add("read-only-amount");
          amountInput.setAttribute(
            "title",
            `${expense.name} is managed from the controls above.`
          );
          amountInput.setAttribute("aria-readonly", "true");
        }
        amountInput.addEventListener("input", (event) => {
          if (event.target.readOnly) {
            return;
          }
          const targetExpense = findExpenseById(event.target.dataset.expenseId);
          if (!targetExpense) {
            return;
          }
          const index = Number(event.target.dataset.personIndex);
          const value = event.target.value.trim();
          targetExpense.amounts[index] = value === "" ? "" : Number(value);
          const desktopAmount = document.querySelector(
            `.attendance-table input[data-expense-id="${expense.id}"][data-person-index="${index}"][data-distance-field!="true"]`
          );
          if (desktopAmount && !desktopAmount.readOnly) {
            desktopAmount.value = value;
          }
          recalculate();
        });
        label.appendChild(amountInput);
        grid.appendChild(label);

        if (expense.key === "petrol") {
          const distanceLabel = document.createElement("label");
          distanceLabel.textContent = "Distance (km)";
          const distanceInput = document.createElement("input");
          distanceInput.type = "number";
          distanceInput.step = "1";
          distanceInput.min = "0";
          distanceInput.inputMode = "numeric";
          const storedDistance = expense.distances[personIndex];
          distanceInput.value = storedDistance !== "" ? storedDistance : "";
          distanceInput.placeholder = "0";
          distanceInput.dataset.expenseId = expense.id;
          distanceInput.dataset.personIndex = String(personIndex);
          distanceInput.dataset.distanceField = "true";
          distanceInput.className = "mobile-distance-input";
          distanceInput.addEventListener("input", (event) => {
            const targetExpense = findExpenseById(event.target.dataset.expenseId);
            if (!targetExpense) {
              return;
            }
            if (!Array.isArray(targetExpense.distances)) {
              targetExpense.distances = [];
            }
            const index = Number(event.target.dataset.personIndex);
            const rawValue = event.target.value.trim();
            if (rawValue === "") {
              targetExpense.distances[index] = "";
            } else {
              const numericValue = Number(rawValue);
              if (Number.isFinite(numericValue)) {
                const sanitizedValue = Math.max(0, Math.round(numericValue));
                targetExpense.distances[index] = sanitizedValue;
                event.target.value = String(sanitizedValue);
              } else {
                targetExpense.distances[index] = "";
              }
            }
            const desktopDistance = document.querySelector(
              `.attendance-table input[data-expense-id="${expense.id}"][data-person-index="${index}"][data-distance-field="true"]`
            );
            if (desktopDistance) {
              desktopDistance.value = targetExpense.distances[index];
            }
            recalculate();
          });
          distanceLabel.appendChild(distanceInput);
          grid.appendChild(distanceLabel);
        }

        const consumeLabel = document.createElement("label");
        consumeLabel.className = "mobile-checkbox-field";
        const consumeInput = document.createElement("input");
        consumeInput.type = "checkbox";
        consumeInput.checked = Boolean(expense.consumers[personIndex]);
        consumeInput.dataset.expenseId = expense.id;
        consumeInput.dataset.personIndex = String(personIndex);
        consumeInput.className = "mobile-consume-input";
        consumeInput.addEventListener("change", (event) => {
          const targetExpense = findExpenseById(event.target.dataset.expenseId);
          if (!targetExpense) {
            return;
          }
          const index = Number(event.target.dataset.personIndex);
          targetExpense.consumers[index] = event.target.checked;
          const desktopConsume = document.querySelector(
            `.attendance-table input[type="checkbox"][data-expense-id="${expense.id}"][data-person-index="${index}"]`
          );
          if (desktopConsume) {
            desktopConsume.checked = event.target.checked;
          }
          recalculate();
        });
        const consumeText = document.createElement("span");
        consumeText.textContent = "Include in share";
        consumeLabel.appendChild(consumeInput);
        consumeLabel.appendChild(consumeText);
        grid.appendChild(consumeLabel);
      });

      panel.appendChild(grid);

      const breakdown = document.createElement("div");
      breakdown.className = "mobile-summary-line mobile-fee-breakdown";
      breakdown.dataset.personIndex = String(personIndex);
      panel.appendChild(breakdown);

      const feeLine = document.createElement("div");
      feeLine.className = "mobile-summary-line";
      feeLine.innerHTML =
        'Fee: <span class="mobile-fee-value" data-person-index="' +
        personIndex +
        '"></span>';
      panel.appendChild(feeLine);

      const reimbLine = document.createElement("div");
      reimbLine.className = "mobile-summary-line";
      reimbLine.innerHTML =
        'Reimburse (Due): <span class="mobile-reimbursed-value" data-person-index="' +
        personIndex +
        '"></span>';
      panel.appendChild(reimbLine);

      return panel;
    }

    function renderMobileTabs(activeExpenses) {
      if (!mobileTabPanels || !generalPanel) {
        return;
      }

      mobileTabPanels
        .querySelectorAll(".mobile-person-panel")
        .forEach((panel) => panel.remove());

      participants.forEach((participant, personIndex) => {
        const panel = createMobilePersonPanel(
          participant,
          personIndex,
          activeExpenses
        );
        panel.id = getPersonTabId(personIndex);
        mobileTabPanels.appendChild(panel);
      });
    }

    function renderTable() {
      syncAllExpenseSizes();
      const activeExpenses = getActiveExpenses();

      const headerRow = document.getElementById("attendance-header");
      headerRow.innerHTML = "";
      const nameHeader = document.createElement("th");
      nameHeader.textContent = "Name";
      headerRow.appendChild(nameHeader);

      activeExpenses.forEach((expense) => {
        const amountHeader = document.createElement("th");
        const directCharge = isDirectChargeExpense(expense);
        amountHeader.textContent = getExpenseHeaderLabel(expense);
        amountHeader.dataset.expenseId = expense.id;
        amountHeader.dataset.directCharge = directCharge ? "true" : "false";
        headerRow.appendChild(amountHeader);

        if (expense.key === "petrol") {
          const distanceHeader = document.createElement("th");
          distanceHeader.dataset.expenseId = expense.id;
          distanceHeader.textContent = "Distance (km)";
          headerRow.appendChild(distanceHeader);
        }

        if (!directCharge) {
          const consumeHeader = document.createElement("th");
          consumeHeader.className = "consume-header";
          consumeHeader.dataset.expenseId = expense.id;
          consumeHeader.textContent = "Inc?";
          headerRow.appendChild(consumeHeader);
        }
      });

      const breakdownHeader = document.createElement("th");
      breakdownHeader.textContent = "Fee Breakdown";
      headerRow.appendChild(breakdownHeader);

      const feeHeader = document.createElement("th");
      feeHeader.textContent = "Fee";
      headerRow.appendChild(feeHeader);

      const reimbHeader = document.createElement("th");
      reimbHeader.className = "reimburse-header";
      reimbHeader.innerHTML =
        '<span class="reimburse-label">Reimburse</span><span class="due-label">(Due)</span>';
      headerRow.appendChild(reimbHeader);

      renderBody(activeExpenses);
      renderFooter(activeExpenses);
      renderMobileTabs(activeExpenses);
      updateDuplicateNameWarnings();
      recalculate();
    }

    function renderBody(activeExpenses) {
      const tbody = document.getElementById("attendance-body");
      tbody.innerHTML = "";

      participants.forEach((participant, personIndex) => {
        const row = document.createElement("tr");

        const nameCell = document.createElement("td");
        const nameWrapper = document.createElement("div");
        nameWrapper.className = "name-input-wrapper";

        const nameInput = document.createElement("input");
        nameInput.type = "text";
        nameInput.value = participant.name;
        nameInput.setAttribute("list", nameListId);
        nameInput.className = "name-input" + (participant.bold ? " bold" : "");
        nameInput.dataset.personIndex = String(personIndex);

        const nameSelect = document.createElement("select");
        nameSelect.className = "name-select";
        nameSelect.dataset.personIndex = String(personIndex);
        nameSelect.setAttribute("aria-label", "Select member from list");
        nameSelect.title = "Select member";
        populateNameSelect(nameSelect);

        nameInput.addEventListener("input", (event) => {
          const value = event.target.value;
          participants[personIndex].name = value;
          if (!memberNames.includes(value)) {
            nameSelect.value = "";
          }
          recalculate();
          updateDuplicateNameWarnings();
          refreshMobileTabLabels();
        });

        nameInput.addEventListener("keydown", (event) => {
          if (event.key !== "Tab" || event.shiftKey) {
            return;
          }
          const nextIndex = personIndex + 1;
          const nextInput = document.querySelector(
            `.name-input[data-person-index="${nextIndex}"]`
          );
          if (!nextInput) {
            return;
          }
          event.preventDefault();
          nextInput.focus();
        });

        nameSelect.addEventListener("change", (event) => {
          const value = event.target.value;
          participants[personIndex].name = value;
          nameInput.value = value;
          recalculate();
          event.target.value = "";
          updateDuplicateNameWarnings();
          refreshMobileTabLabels();
        });

        nameWrapper.appendChild(nameInput);
        nameWrapper.appendChild(nameSelect);
        nameCell.appendChild(nameWrapper);
        row.appendChild(nameCell);

        activeExpenses.forEach((expense) => {
          ensureExpenseSize(expense);
          const directCharge = isDirectChargeExpense(expense);
          const amountCell = document.createElement("td");
          if (directCharge) {
            amountCell.classList.add("consume-cell");
            const consumeInput = document.createElement("input");
            consumeInput.type = "checkbox";
            consumeInput.checked = Boolean(expense.consumers[personIndex]);
            consumeInput.dataset.expenseId = expense.id;
            consumeInput.dataset.personIndex = String(personIndex);
            consumeInput.setAttribute(
              "aria-label",
              `${expense.name} consumed`
            );
            consumeInput.addEventListener("change", (event) => {
              const targetExpense = findExpenseById(event.target.dataset.expenseId);
              if (!targetExpense) {
                return;
              }
              const index = Number(event.target.dataset.personIndex);
              targetExpense.consumers[index] = event.target.checked;
              recalculate();
            });
            amountCell.appendChild(consumeInput);
            row.appendChild(amountCell);
            return;
          }

          const amountInput = document.createElement("input");
          amountInput.type = "number";
          amountInput.step = "0.01";
          amountInput.value = expense.amounts[personIndex] !== "" ? expense.amounts[personIndex] : "";
          amountInput.placeholder = "0.00";
          amountInput.dataset.expenseId = expense.id;
          amountInput.dataset.personIndex = String(personIndex);
          if (isBaseRateControlled(expense)) {
            const rate = baseExpenseRates[expense.key];
            amountInput.value = rate === "" ? "" : rate;
            amountInput.readOnly = true;
            amountInput.tabIndex = -1;
            amountInput.classList.add("read-only-amount");
            amountInput.setAttribute(
              "title",
              `${expense.name} is managed from the controls above.`
            );
            amountInput.setAttribute("aria-readonly", "true");
          }
          amountInput.addEventListener("input", (event) => {
            if (event.target.readOnly) {
              return;
            }
            const targetExpense = findExpenseById(event.target.dataset.expenseId);
            if (!targetExpense) {
              return;
            }
            const index = Number(event.target.dataset.personIndex);
            const value = event.target.value.trim();
            targetExpense.amounts[index] = value === "" ? "" : Number(value);
            recalculate();
          });
          amountCell.appendChild(amountInput);
          row.appendChild(amountCell);

          if (expense.key === "petrol") {
            if (!Array.isArray(expense.distances)) {
              expense.distances = participants.map(() => "");
            }
            const distanceCell = document.createElement("td");
            const distanceInput = document.createElement("input");
            distanceInput.type = "number";
            distanceInput.step = "1";
            distanceInput.min = "0";
            distanceInput.inputMode = "numeric";
            const storedDistance = expense.distances[personIndex];
            distanceInput.value = storedDistance !== "" ? storedDistance : "";
            distanceInput.placeholder = "0";
            distanceInput.dataset.expenseId = expense.id;
            distanceInput.dataset.personIndex = String(personIndex);
            distanceInput.dataset.distanceField = "true";
            distanceInput.setAttribute(
              "aria-label",
              "Distance travelled in kilometres"
            );
            distanceInput.addEventListener("input", (event) => {
              const targetExpense = findExpenseById(event.target.dataset.expenseId);
              if (!targetExpense) {
                return;
              }
              if (!Array.isArray(targetExpense.distances)) {
                targetExpense.distances = [];
              }
              const index = Number(event.target.dataset.personIndex);
              const rawValue = event.target.value.trim();
              if (rawValue === "") {
                targetExpense.distances[index] = "";
              } else {
                const numericValue = Number(rawValue);
                if (Number.isFinite(numericValue)) {
                  const sanitizedValue = Math.max(0, Math.round(numericValue));
                  targetExpense.distances[index] = sanitizedValue;
                  event.target.value = String(sanitizedValue);
                } else {
                  targetExpense.distances[index] = "";
                }
              }
              recalculate();
            });
            distanceCell.appendChild(distanceInput);
            row.appendChild(distanceCell);
          }

          const consumeCell = document.createElement("td");
          consumeCell.className = "consume-cell";
          const consumeInput = document.createElement("input");
          consumeInput.type = "checkbox";
          consumeInput.checked = Boolean(expense.consumers[personIndex]);
          consumeInput.dataset.expenseId = expense.id;
          consumeInput.dataset.personIndex = String(personIndex);
          consumeInput.setAttribute(
            "aria-label",
            `${expense.name} consumed`
          );
          consumeInput.addEventListener("change", (event) => {
            const targetExpense = findExpenseById(event.target.dataset.expenseId);
            if (!targetExpense) {
              return;
            }
            const index = Number(event.target.dataset.personIndex);
            targetExpense.consumers[index] = event.target.checked;
            recalculate();
          });
          consumeCell.appendChild(consumeInput);
          row.appendChild(consumeCell);
        });

        const breakdownCell = document.createElement("td");
        breakdownCell.className = "fee-breakdown";
        breakdownCell.dataset.personIndex = personIndex;
        row.appendChild(breakdownCell);

        const feeCell = document.createElement("td");
        feeCell.className = "fee-value";
        feeCell.dataset.personIndex = personIndex;
        row.appendChild(feeCell);

        const reimbCell = document.createElement("td");
        reimbCell.className = "reimbursed-value";
        reimbCell.dataset.personIndex = personIndex;
        row.appendChild(reimbCell);

        tbody.appendChild(row);
      });
    }

    function renderFooter(activeExpenses) {
      const tfoot = document.getElementById("attendance-foot");
      tfoot.innerHTML = "";
      const row = document.createElement("tr");
      row.className = "totals-row";

      const blankCell = document.createElement("td");
      blankCell.textContent = "";
      row.appendChild(blankCell);

      activeExpenses.forEach((expense) => {
        const totalCell = document.createElement("td");
        totalCell.className = "expense-total";
        totalCell.dataset.expenseId = expense.id;
        totalCell.textContent = "Total: $0.00";
        if (isDirectChargeExpense(expense)) {
          totalCell.dataset.directCharge = "true";
          row.appendChild(totalCell);
        } else {
          row.appendChild(totalCell);

          if (expense.key === "petrol") {
            const distanceCell = document.createElement("td");
            distanceCell.className = "expense-distance-summary";
            distanceCell.dataset.expenseId = expense.id;
            distanceCell.textContent = "Distance: 0 km";
            row.appendChild(distanceCell);
          }

          const consumersCell = document.createElement("td");
          consumersCell.className = "expense-consumers";
          consumersCell.dataset.expenseId = expense.id;
          consumersCell.textContent = "Consumers: 0";
          row.appendChild(consumersCell);
        }
      });

      const breakdownCell = document.createElement("td");
      breakdownCell.innerHTML = "<strong>Total</strong>";
      row.appendChild(breakdownCell);

      const feeCell = document.createElement("td");
      feeCell.className = "fee-value total-fee";
      row.appendChild(feeCell);

      const reimbCell = document.createElement("td");
      reimbCell.className = "reimbursed-value total-reimbursed";
      row.appendChild(reimbCell);

      const noteCell = document.createElement("td");
      noteCell.textContent = "";
      row.appendChild(noteCell);

      tfoot.appendChild(row);
    }

    function syncSrtKitMasterToggleState() {
      if (!srtKitMasterToggle) {
        return;
      }

      const srtKitExpense = getSrtKitExpense();
      if (!srtKitExpense) {
        srtKitMasterToggle.checked = false;
        srtKitMasterToggle.indeterminate = false;
        srtKitMasterToggle.disabled = true;
        return;
      }

      if (!srtKitExpense.enabled) {
        srtKitMasterToggle.checked = false;
        srtKitMasterToggle.indeterminate = false;
        srtKitMasterToggle.disabled = true;
        return;
      }

      srtKitMasterToggle.disabled = false;
      ensureExpenseSize(srtKitExpense);

      let relevantIndexes = participants
        .map((participant, index) => ({
          index,
          hasName: Boolean(participant.name && participant.name.trim())
        }))
        .filter((entry) => entry.hasName);

      if (relevantIndexes.length === 0) {
        relevantIndexes = participants.map((_, index) => ({ index }));
      }

      const total = relevantIndexes.length;
      let checkedCount = 0;
      relevantIndexes.forEach(({ index }) => {
        if (srtKitExpense.consumers[index]) {
          checkedCount += 1;
        }
      });

      if (total === 0) {
        srtKitMasterToggle.checked = false;
        srtKitMasterToggle.indeterminate = false;
        return;
      }

      srtKitMasterToggle.indeterminate =
        checkedCount > 0 && checkedCount < total;
      srtKitMasterToggle.checked = checkedCount === total;
    }

    function syncMobileInputsFromState() {
      participants.forEach((participant, personIndex) => {
        const nameInput = document.querySelector(
          `.mobile-name-input[data-person-index="${personIndex}"]`
        );
        syncInputValueIfInactive(nameInput, participant.name);

      });

      getAllExpenses().forEach((expense) => {
        ensureExpenseSize(expense);
        expense.consumers.forEach((consumerState, personIndex) => {
          const directChargeInput = document.querySelector(
            `.mobile-direct-charge[data-expense-id="${expense.id}"][data-person-index="${personIndex}"]`
          );
          syncInputValueIfInactive(directChargeInput, consumerState, true);

          const consumeInput = document.querySelector(
            `.mobile-consume-input[data-expense-id="${expense.id}"][data-person-index="${personIndex}"]`
          );
          syncInputValueIfInactive(consumeInput, consumerState, true);
        });

        expense.amounts.forEach((amount, personIndex) => {
          const amountInput = document.querySelector(
            `.mobile-amount-input[data-expense-id="${expense.id}"][data-person-index="${personIndex}"]`
          );
          if (amountInput && !amountInput.readOnly) {
            const value = amount === "" ? "" : String(amount);
            syncInputValueIfInactive(amountInput, value);
          }

          if (expense.key === "petrol") {
            const distanceInput = document.querySelector(
              `.mobile-distance-input[data-expense-id="${expense.id}"][data-person-index="${personIndex}"]`
            );
            const distance = Array.isArray(expense.distances)
              ? expense.distances[personIndex]
              : "";
            syncInputValueIfInactive(distanceInput, distance);
          }
        });
      });
    }

    function syncDesktopInputsFromState() {
      participants.forEach((participant, personIndex) => {
        const nameInput = document.querySelector(
          `.name-input[data-person-index="${personIndex}"]`
        );
        syncInputValueIfInactive(nameInput, participant.name);
      });

      getAllExpenses().forEach((expense) => {
        ensureExpenseSize(expense);
        expense.consumers.forEach((consumerState, personIndex) => {
          const consumeInput = document.querySelector(
            `.attendance-table input[type="checkbox"][data-expense-id="${expense.id}"][data-person-index="${personIndex}"]`
          );
          syncInputValueIfInactive(consumeInput, consumerState, true);
        });

        expense.amounts.forEach((amount, personIndex) => {
          const amountInput = document.querySelector(
            `.attendance-table input[type="number"][data-expense-id="${expense.id}"][data-person-index="${personIndex}"][data-distance-field!="true"]`
          );
          if (amountInput && !amountInput.readOnly) {
            const value = amount === "" ? "" : String(amount);
            syncInputValueIfInactive(amountInput, value);
          }

          if (expense.key === "petrol") {
            const distanceInput = document.querySelector(
              `.attendance-table input[type="number"][data-expense-id="${expense.id}"][data-person-index="${personIndex}"][data-distance-field="true"]`
            );
            const distance = Array.isArray(expense.distances)
              ? expense.distances[personIndex]
              : "";
            syncInputValueIfInactive(distanceInput, distance);
          }
        });
      });
    }

    function calculateFinancials(applyDomUpdates = true) {
      const activeExpenses = getActiveExpenses();
      const participantFeeTotals = new Array(participants.length).fill(0);
      const participantFeeBreakdowns = participants.map(() => []);
      const participantContributions = new Array(participants.length).fill(0);
      const participantContributionDetails = participants.map(() => []);
      const participantHasName = participants.map(
        (participant) => Boolean(participant.name && participant.name.trim())
      );
      let clubIncome = 0;

      activeExpenses.forEach((expense) => {
        ensureExpenseSize(expense);
        if (isDirectChargeExpense(expense)) {
          const rateValue = baseExpenseRates[expense.key];
          const numericRate = Number(rateValue);
          const perPersonCharge = Number.isFinite(numericRate) ? numericRate : 0;
          let total = 0;
          let consumerCount = 0;

          participants.forEach((participant, personIndex) => {
            if (!participantHasName[personIndex]) {
              return;
            }
            if (expense.consumers[personIndex]) {
              consumerCount += 1;
              const charge = perPersonCharge;
              participantFeeTotals[personIndex] += charge;
              if (charge > 0) {
                participantFeeBreakdowns[personIndex].push({
                  name: expense.name,
                  value: charge
                });
              }
              if (charge > 0) {
                clubIncome += charge;
              }
              total += charge;
            }
          });

          if (applyDomUpdates) {
            const totalCell = document.querySelector(
              `.expense-total[data-expense-id="${expense.id}"]`
            );
            if (totalCell) {
              const totalText = formatCurrency(total);
              totalCell.innerHTML = `Total: $${totalText || "0.00"}`;
              const summary = document.createElement("div");
              summary.textContent = `Selected: ${consumerCount}`;
              totalCell.appendChild(summary);
            }

            const consumersCell = document.querySelector(
              `.expense-consumers[data-expense-id="${expense.id}"]`
            );
            if (consumersCell) {
              consumersCell.textContent = `Consumers: ${consumerCount}`;
            }
          }

          return;
        }

        let fuelTotal = 0;
        let totalDistance = 0;
        const consumers = [];
        let driverDistances = [];
        let driverHasDistance = [];

        if (expense.key === "petrol") {
          driverDistances = new Array(participants.length).fill(0);
          driverHasDistance = new Array(participants.length).fill(false);
        }

        expense.amounts.forEach((amount, personIndex) => {
          const hasName = participantHasName[personIndex];
          if (hasName && amount !== "" && Number.isFinite(Number(amount))) {
            const numericAmount = Number(amount);
            fuelTotal += numericAmount;
            participantContributions[personIndex] += numericAmount;
            participantContributionDetails[personIndex].push({
              name: expense.name,
              value: numericAmount,
              distance: null
            });
          }
          if (expense.key === "petrol" && hasName) {
            if (!Array.isArray(expense.distances)) {
              expense.distances = participants.map(() => "");
            }
            const distanceValue = expense.distances[personIndex];
            if (distanceValue !== "") {
              const numericDistance = Number(distanceValue);
              if (Number.isFinite(numericDistance)) {
                totalDistance += numericDistance;
                driverDistances[personIndex] = numericDistance;
                driverHasDistance[personIndex] = true;
                const contributionEntry = participantContributionDetails[personIndex];
                const lastEntry = contributionEntry[contributionEntry.length - 1];
                if (lastEntry && lastEntry.name === expense.name && lastEntry.distance === null) {
                  lastEntry.distance = numericDistance;
                } else {
                  contributionEntry.push({
                    name: expense.name,
                    value: 0,
                    distance: numericDistance
                  });
                }
              }
            }
          }
          if (hasName && expense.consumers[personIndex]) {
            consumers.push(personIndex);
          }
        });

        const effectiveMaintenanceRate = getEffectiveMaintenanceRate();
        const maintenanceRateText = formatMaintenanceRateDisplay(
          effectiveMaintenanceRate
        );
        const maintenanceTotal =
          expense.key === "petrol" ? totalDistance * effectiveMaintenanceRate : 0;
        const combinedTotal = fuelTotal + maintenanceTotal;
        const consumerCount = consumers.length;
        const combinedShare = consumerCount > 0 ? combinedTotal / consumerCount : 0;
        const fuelShare = consumerCount > 0 ? fuelTotal / consumerCount : 0;
        const maintenanceShare = consumerCount > 0 ? maintenanceTotal / consumerCount : 0;

        consumers.forEach((personIndex) => {
          participantFeeTotals[personIndex] += combinedShare;
          if (fuelShare > 0) {
            participantFeeBreakdowns[personIndex].push({
              name: expense.name,
              value: fuelShare
            });
          }
          if (maintenanceShare > 0) {
            participantFeeBreakdowns[personIndex].push({
              name: "Maintenance",
              value: maintenanceShare
            });
          }
        });

        if (expense.key === "petrol") {
          driverDistances.forEach((distance, personIndex) => {
            if (!driverHasDistance[personIndex]) {
              return;
            }
            const maintenanceCredit = distance * effectiveMaintenanceRate;
            if (maintenanceCredit > 0) {
              participantFeeTotals[personIndex] -= maintenanceCredit;
              participantFeeBreakdowns[personIndex].push({
                name: "Maintenance credit",
                value: -maintenanceCredit
              });
            }
          });
        }

        if (applyDomUpdates) {
          const totalCell = document.querySelector(
            `.expense-total[data-expense-id="${expense.id}"]`
          );
          if (totalCell) {
            const totalText = formatCurrency(combinedTotal);
            totalCell.innerHTML = `Total: $${totalText || "0.00"}`;
            if (expense.key === "petrol") {
              const fuelLine = document.createElement("div");
              fuelLine.textContent = `Fuel: $${formatCurrency(fuelTotal) || "0.00"}`;
              const maintenanceLine = document.createElement("div");
              const maintenanceAmount = formatCurrency(maintenanceTotal) || "0.00";
              const distanceText = `${Math.round(totalDistance) || 0} km`;
              maintenanceLine.textContent = `Maintenance ($${maintenanceRateText || "0"}/km): $${maintenanceAmount} (${distanceText})`;
              totalCell.appendChild(fuelLine);
              totalCell.appendChild(maintenanceLine);
            }
          }
          if (expense.key === "petrol") {
            const distanceSummaryCell = document.querySelector(
              `.expense-distance-summary[data-expense-id="${expense.id}"]`
            );
            if (distanceSummaryCell) {
              const roundedDistance = Math.round(totalDistance) || 0;
              distanceSummaryCell.textContent = `Distance: ${roundedDistance} km`;
            }
          }
          const consumersCell = document.querySelector(
            `.expense-consumers[data-expense-id="${expense.id}"]`
          );
          if (consumersCell) {
            const shareText =
              consumerCount > 0
                ? `Share: $${formatCurrency(combinedShare) || "0.00"}`
                : "Share: $0.00";
            consumersCell.innerHTML = `<div>Consumers: ${consumerCount}</div><div>${shareText}</div>`;
          }
        }
      });

      let totalFees = 0;
      let totalBalance = 0;
      const balances = new Array(participants.length).fill(0);

      participants.forEach((participant, personIndex) => {
        const hasName = participantHasName[personIndex];
        const fee = hasName ? participantFeeTotals[personIndex] : 0;
        const contributions = hasName ? participantContributions[personIndex] : 0;
        const balance = fee - contributions;
        balances[personIndex] = balance;

        if (hasName) {
          totalFees += fee;
          totalBalance += balance;
        }

        if (!applyDomUpdates) {
          return;
        }

        const breakdownCell = document.querySelector(
          `.fee-breakdown[data-person-index="${personIndex}"]`
        );
        const feeCell = document.querySelector(
          `.fee-value[data-person-index="${personIndex}"]`
        );
        const reimbCell = document.querySelector(
          `.reimbursed-value[data-person-index="${personIndex}"]`
        );

        if (breakdownCell) {
          if (hasName) {
            const breakdown = participantFeeBreakdowns[personIndex];
            breakdownCell.textContent = breakdown.length
              ? breakdown
                  .map((entry) => `${entry.name}: $${formatCurrency(entry.value) || "0.00"}`)
                  .join("; ")
              : "";
          } else {
            breakdownCell.textContent = "";
          }
        }
        if (feeCell) {
          feeCell.textContent = hasName && fee ? `$${formatCurrency(fee)}` : "";
        }
        if (reimbCell) {
          reimbCell.textContent = "";
          reimbCell.classList.remove("amount-due", "amount-credit");
          if (hasName && balance) {
            if (balance > 0) {
              reimbCell.textContent = `($${formatCurrency(balance)})`;
              reimbCell.classList.add("amount-due");
            } else {
              reimbCell.textContent = `$${formatCurrency(Math.abs(balance))}`;
              reimbCell.classList.add("amount-credit");
            }
          }
        }

        const mobileBreakdown = document.querySelector(
          `.mobile-fee-breakdown[data-person-index="${personIndex}"]`
        );
        const mobileFee = document.querySelector(
          `.mobile-fee-value[data-person-index="${personIndex}"]`
        );
        const mobileReimb = document.querySelector(
          `.mobile-reimbursed-value[data-person-index="${personIndex}"]`
        );

        if (mobileBreakdown) {
          if (hasName) {
            const breakdown = participantFeeBreakdowns[personIndex];
            mobileBreakdown.textContent = breakdown.length
              ? breakdown
                  .map((entry) => `${entry.name}: $${formatCurrency(entry.value) || "0.00"}`)
                  .join("; ")
              : "";
          } else {
            mobileBreakdown.textContent = "";
          }
        }

        if (mobileFee) {
          mobileFee.textContent = hasName && fee ? `$${formatCurrency(fee)}` : "";
        }

        if (mobileReimb) {
          mobileReimb.textContent = "";
          mobileReimb.classList.remove("amount-due", "amount-credit");
          if (hasName && balance) {
            if (balance > 0) {
              mobileReimb.textContent = `($${formatCurrency(balance)})`;
              mobileReimb.classList.add("amount-due");
            } else {
              mobileReimb.textContent = `$${formatCurrency(Math.abs(balance))}`;
              mobileReimb.classList.add("amount-credit");
            }
          }
        }
      });

      if (applyDomUpdates) {
        const totalFeeCell = document.querySelector(".total-fee");
        if (totalFeeCell) {
          totalFeeCell.textContent = totalFees ? `$${formatCurrency(totalFees)}` : "";
        }

        const totalReimbCell = document.querySelector(".total-reimbursed");
        if (totalReimbCell) {
          totalReimbCell.textContent = "";
          totalReimbCell.classList.remove("amount-due", "amount-credit");
          if (totalBalance) {
            const prefix = document.createTextNode("Club Gear Depreciation: ");
            totalReimbCell.appendChild(prefix);
            const valueSpan = document.createElement("span");
            if (totalBalance > 0) {
              valueSpan.textContent = `($${formatCurrency(totalBalance)})`;
              valueSpan.classList.add("amount-due");
            } else {
              valueSpan.textContent = `$${formatCurrency(Math.abs(totalBalance))}`;
              valueSpan.classList.add("amount-credit");
            }
            totalReimbCell.appendChild(valueSpan);
          }
        }

        const clubIncomeCell = document.getElementById("club-income-value");
        if (clubIncomeCell) {
          clubIncomeCell.textContent = clubIncome ? `$${formatCurrency(clubIncome)}` : "";
        }

        syncMobileInputsFromState();
        syncDesktopInputsFromState();
        syncSrtKitMasterToggleState();
      }

      return {
        activeExpenses,
        participantFeeTotals,
        participantFeeBreakdowns,
        participantContributions,
        participantContributionDetails,
        balances,
        totalFees,
        totalBalance,
        clubIncome
      };
    }

    function recalculate() {
      return calculateFinancials(true);
    }

    document.getElementById("add-expense").addEventListener("click", () => {
      const expenseName = window.prompt("Enter a name for the new expense:");
      if (!expenseName) {
        return;
      }
      const trimmed = expenseName.trim();
      if (!trimmed) {
        return;
      }
      customExpenses.push(createExpense({ name: trimmed }));
      renderTable();
    });

    document.getElementById("remove-expense").addEventListener("click", () => {
      if (customExpenses.length === 0) {
        window.alert("There are no custom expenses to remove.");
        return;
      }
      const namesList = customExpenses.map((expense) => expense.name).join(", ");
      const targetName = window.prompt(
        `Enter the name of the expense to remove:\n${namesList}`
      );
      if (!targetName) {
        return;
      }
      const trimmed = targetName.trim().toLowerCase();
      const index = customExpenses.findIndex(
        (expense) => expense.name.toLowerCase() === trimmed
      );
      if (index === -1) {
        window.alert(`Could not find an expense named "${targetName}".`);
        return;
      }
      customExpenses.splice(index, 1);
      renderTable();
    });

    document.getElementById("save-json").addEventListener("click", () => {
      downloadAttendanceJson();
    });

    const loadJsonInput = document.getElementById("load-json-input");
    document.getElementById("load-json").addEventListener("click", () => {
      loadJsonInput.value = "";
      loadJsonInput.click();
    });

    loadJsonInput.addEventListener("change", (event) => {
      const [file] = event.target.files;
      if (!file) {
        return;
      }
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const result = reader.result;
          const textContent =
            typeof result === "string" ? result : new TextDecoder().decode(result);
          loadTableFromJsonContent(textContent);
        } catch (error) {
          console.error("Could not load JSON", error);
          window.alert("Could not load JSON. Please check the file format.");
        }
      };
      reader.readAsText(file);
    });

    const summariseButton = document.getElementById("summarise-button");
    if (summariseButton) {
      summariseButton.addEventListener("click", () => {
        downloadAndOpenSummaryHtml();
      });
    }

    function addParticipantRow() {
      participants.push({ name: "", bold: false });
      if (srtKitMasterToggle && srtKitMasterToggle.checked) {
        const srtKitExpense = getSrtKitExpense();
        if (srtKitExpense && srtKitExpense.enabled) {
          ensureExpenseSize(srtKitExpense);
          srtKitExpense.consumers[participants.length - 1] = true;
        }
      }
      renderTable();
      window.requestAnimationFrame(() => {
        focusMobilePerson(participants.length - 1);
      });
    }

    const addRowButton = document.getElementById("add-row");
    if (addRowButton) {
      addRowButton.addEventListener("click", addParticipantRow);
    }

    if (mobileAddPersonButton) {
      mobileAddPersonButton.addEventListener("click", addParticipantRow);
    }

    document.getElementById("remove-row").addEventListener("click", () => {
      if (participants.length === 0) {
        return;
      }
      const lastParticipant = participants[participants.length - 1];
      const hasName = Boolean(lastParticipant?.name && lastParticipant.name.trim());
      if (hasName && !window.confirm("Remove the last participant row?")) {
        return;
      }
      participants.pop();
      renderTable();
    });

    document
      .querySelectorAll('.expense-toggle-group input[type="checkbox"]')
      .forEach((checkbox) => {
        const key = checkbox.dataset.expenseKey;
        const expense = baseExpenses.find((item) => item.key === key);
        if (!expense) {
          return;
        }
        checkbox.checked = expense.enabled;
        checkbox.addEventListener("change", (event) => {
          expense.enabled = event.target.checked;
          renderTable();
        });
      });

    if (srtKitMasterToggle) {
      srtKitMasterToggle.addEventListener("change", (event) => {
        const srtKitExpense = getSrtKitExpense();
        if (!srtKitExpense || !srtKitExpense.enabled) {
          srtKitMasterToggle.checked = false;
          srtKitMasterToggle.indeterminate = false;
          return;
        }

        ensureExpenseSize(srtKitExpense);
        const desired = event.target.checked;
        for (let index = 0; index < srtKitExpense.consumers.length; index += 1) {
          srtKitExpense.consumers[index] = desired;
        }

        document
          .querySelectorAll(
            `input[type="checkbox"][data-expense-id="${srtKitExpense.id}"]`
          )
          .forEach((checkbox) => {
            checkbox.checked = desired;
          });

        srtKitMasterToggle.indeterminate = false;
        recalculate();
      });
    }

    function normalizeBankingDetails(details) {
      if (!details || typeof details !== "object") {
        return { name: "", bsb: "", account: "" };
      }

      const name =
        details.Name !== undefined ? details.Name : details.name !== undefined ? details.name : "";
      const bsb =
        details.BSB !== undefined ? details.BSB : details.bsb !== undefined ? details.bsb : "";
      const account =
        details.Account !== undefined
          ? details.Account
          : details.account !== undefined
            ? details.account
            : "";

      return {
        name: typeof name === "string" || typeof name === "number" ? String(name).trim() : "",
        bsb: typeof bsb === "string" || typeof bsb === "number" ? String(bsb).trim() : "",
        account:
          typeof account === "string" || typeof account === "number" ? String(account).trim() : ""
      };
    }

    function getCurrentBankingDetails() {
      if (bankingDetailsData) {
        return normalizeBankingDetails(bankingDetailsData);
      }

      if (defaultBankingDetails) {
        return normalizeBankingDetails(defaultBankingDetails);
      }

      return normalizeBankingDetails(null);
    }

    function populateBankingFormFields() {
      if (!bankingForm) {
        return;
      }

      const current = getCurrentBankingDetails();

      if (bankingNameInput) {
        bankingNameInput.placeholder = current.name || "Account name";
        bankingNameInput.value = current.name;
      }

      if (bankingBsbInput) {
        bankingBsbInput.placeholder = current.bsb || "BSB";
        bankingBsbInput.value = current.bsb;
      }

      if (bankingAccountInput) {
        bankingAccountInput.placeholder = current.account || "Account number";
        bankingAccountInput.value = current.account;
      }
    }

    function renderBankingDetailsInto(container, targetDocument = document) {
      if (!container) {
        return;
      }

      const doc = targetDocument || document;
      const lines = [];
      const { name, bsb, account } = getCurrentBankingDetails();

      const baseLines = [
        { label: "Name", value: name },
        { label: "BSB", value: bsb },
        { label: "Account", value: account }
      ].filter((item) => item.value && String(item.value).trim() !== "");

      lines.push(...baseLines);

      const bankingTag = getDateLocationTag();
      if (bankingTag) {
        lines.push({ label: "Tag", value: bankingTag });
      }

      container.innerHTML = "";

      if (lines.length === 0) {
        return;
      }

      lines.forEach((line) => {
        const paragraph = doc.createElement("p");
        const labelSpan = doc.createElement("span");
        labelSpan.classList.add("banking-label");
        labelSpan.textContent = `${line.label}:`;
        const valueSpan = doc.createElement("span");
        valueSpan.textContent = String(line.value);
        paragraph.appendChild(labelSpan);
        paragraph.appendChild(valueSpan);
        container.appendChild(paragraph);
      });
    }

    function renderBankingDetails() {
      const container = document.getElementById("banking-details");
      renderBankingDetailsInto(container, document);
    }

    function applyBankingFormChanges(event) {
      event.preventDefault();

      const current = getCurrentBankingDetails();
      const next = {
        name: (bankingNameInput?.value || "").trim() || current.name,
        bsb: (bankingBsbInput?.value || "").trim() || current.bsb,
        account: (bankingAccountInput?.value || "").trim() || current.account
      };

      bankingDetailsData = next;
      bankingDetailsEdited = true;
      renderBankingDetails();

      if (bankingDialog?.open) {
        bankingDialog.close();
      }
    }

    function setupBankingEditor() {
      if (editBankingButton && bankingDialog && typeof bankingDialog.showModal === "function") {
        editBankingButton.addEventListener("click", () => {
          populateBankingFormFields();
          bankingDialog.showModal();
          if (bankingNameInput) {
            bankingNameInput.focus();
          }
        });
      }

      if (bankingForm) {
        bankingForm.addEventListener("submit", applyBankingFormChanges);
      }

      if (bankingCancelButton) {
        bankingCancelButton.addEventListener("click", () => {
          if (bankingDialog?.open) {
            bankingDialog.close();
          }
        });
      }
    }

    function setupImageReplacements() {
      setupImageReplacement(replaceBannerButton, bannerImageInput, (source) => {
        bannerImageSource = source;
        syncImageSources();
      });

      setupImageReplacement(replaceMinerButton, minerImageInput, (source) => {
        minerImageSource = source;
        syncImageSources();
      });

      setupImageReplacement(
        replaceBankingLogoButton,
        bankingLogoInput,
        (source) => {
          bankingLogoSource = source;
          syncImageSources();
        }
      );

      syncImageSources();
    }

    async function loadBankingDetails() {
      if (bankingDetailsEdited) {
        return;
      }

      try {
        const response = await fetch("banking.json");
        if (!response.ok) {
          bankingDetailsData = null;
          renderBankingDetails();
          return;
        }
        const data = await response.json();
        const normalized = normalizeBankingDetails(
          data && typeof data === "object" ? data : null
        );
        defaultBankingDetails = normalized;
        if (bankingDetailsEdited) {
          return;
        }
        bankingDetailsData = normalized;
      } catch (error) {
        console.warn("Could not load banking details", error);
        if (!bankingDetailsEdited) {
          bankingDetailsData = defaultBankingDetails;
        }
      }

      renderBankingDetails();
    }

    async function loadClerk() {
      try {
        const response = await fetch("signature.txt");
        if (!response.ok) {
          return;
        }
        const text = await response.text();
        const cleaned = text.trim();
        if (clerkInput && !clerkInput.value) {
          clerkInput.value = cleaned;
        }
      } catch (error) {
        console.warn("Could not load clerk", error);
      }
    }

    syncBaseExpenseInputsFromRates();
    loadMemberOptions();
    setupImageReplacements();
    setupBankingEditor();
    renderTable();
    renderBankingDetails();
    loadBankingDetails();
    loadClerk();
  </script>
</body>
</html>
